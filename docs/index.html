<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">
  <title>æ³•äººè²·è³£è¶…æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    @media (max-width: 768px) {
      .mobile-reset { transform: scale(1) !important; padding: 1rem !important; }
      .mobile-col { grid-template-columns: 1fr !important; gap: 1.5rem !important; }
      .mobile-center { text-align: center !important; }
      input, select, button { font-size: 1rem; padding: 0.6rem 0.8rem; }
      h1 { font-size: 1.8rem; }
      h3 { font-size: 1.5rem; }
    }
    #suggestions { z-index: 20; }
    #clear-input-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.15s;
    }
    #clear-input-btn:hover {
      color: #6b7280;
    }
    /* âœ… å¢å¼·æ¨£å¼ä»¥éš±è— Lightweight Charts çš„ Logo å’Œ Watermark */
    /* å¦‚æœ Logo ä»ç„¶å­˜åœ¨ï¼Œè«‹æ¸…é™¤æ‚¨çš„ç€è¦½å™¨å¿«å– (Ctrl+F5) */
    .tv-lightweight-charts-logo,
    .tv-lightweight-charts-watermark,
    .tv-lightweight-charts-watermark__text,
    .tv-watermark,
    .tv-logo {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
  </style>
</head>

<body class="p-6 bg-gray-50 text-lg">
  <div class="max-w-7xl mx-auto transform scale-150 origin-top mobile-reset transition-transform duration-300">

    <h1 id="page-title" class="text-3xl font-bold mb-8 mobile-center">
      æ³•äººè²·è³£è¶…æŸ¥è©¢
    </h1>

    <div class="my-6 flex flex-col md:flex-row md:items-center md:space-x-3 relative w-full md:w-80 mx-auto md:mx-0">
      <label for="search-input" class="font-bold text-xl mb-2 md:mb-0 whitespace-nowrap mobile-center">
        è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼š
      </label>
      <div class="relative w-full md:w-80">
        <input type="text" id="search-input"
               placeholder="å°ç©é›» æˆ– 2330"
               class="w-full border p-3 rounded text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
               autocomplete="off"
               autofocus>
        <button id="clear-input-btn" class="absolute hidden focus:outline-none" title="æ¸…é™¤è¼¸å…¥">
            &times;
        </button>
        <ul id="suggestions"
            class="absolute w-full bg-white border rounded mt-1 shadow-lg hidden max-h-60 overflow-y-auto z-20 text-lg"></ul>
      </div>
    </div>

    <div id="insights-view">
      <div class="grid grid-cols-2 gap-6 mb-8 mobile-col">
        <div class="p-6 border rounded bg-white shadow">
          <h3 id="insights-title" class="font-bold text-2xl mb-6 mobile-center">ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–®</h3>

          <div class="grid grid-cols-2 gap-6 text-gray-700">
            <div>
              <h4 class="font-semibold mb-3">ğŸŒ ç•¶æ—¥å¤–æœ¬æ¯”å‰ 10</h4>
              <ul id="foreign_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
            </div>
            <div>
              <h4 class="font-semibold mb-3">ğŸ¦ ç•¶æ—¥æŠ•æœ¬æ¯”å‰ 10</h4>
              <ul id="invest_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
            </div>
          </div>

          <div id="period-section" class="mt-8"></div>
        </div>

        <div class="p-6 border rounded bg-white shadow">
          <div class="grid grid-cols-2 gap-6 mobile-col">
            <div>
              <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸš€ æ–°ä¸Šæ¦œ</h3>
              <div id="newcomers-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
            </div>
            <div>
              <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸ”¥ çˆ†é‡åµæ¸¬</h3>
              <div id="explosive-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="stock-view" class="hidden">
        <div id="kline-chart-wrapper" class="p-6 border rounded bg-white shadow mb-8">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                <h3 class="font-bold text-2xl mb-2 md:mb-0 mobile-center">è‚¡åƒ¹ K ç·šåœ–</h3>
                <div id="kline-period-selection" class="flex space-x-2 justify-center md:justify-end mt-2 md:mt-0">
                    <button class="period-btn p-2 border rounded bg-blue-500 text-white font-medium text-base hover:bg-blue-600 transition-colors" data-period="D">æ—¥ç·š</button>
                    <button class="period-btn p-2 border rounded bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-base transition-colors" data-period="W">å‘¨ç·š</button>
                    <button class="period-btn p-2 border rounded bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-base transition-colors" data-period="M">æœˆç·š</button>
                </div>
            </div>
            <div id="klineChartContainer" class="relative" style="height: 300px;">
                <div class="text-center py-4 text-gray-500">è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ä»¥è¼‰å…¥ K ç·šè³‡æ–™...</div>
            </div>
        </div>

        <div id="chart-container" class="p-6 border rounded bg-white shadow mb-8">
            <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶…è¶¨å‹¢åœ– (Chart.js)</h3>
            <div class="relative h-96">
                <canvas id="tradingChart"></canvas>
            </div>
        </div>

        <div class="p-6 border rounded bg-white shadow overflow-x-auto">
            <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶… (å¼µ)</h3>
            <table id="trading-table" class="min-w-full text-center border-collapse border text-lg">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
                        <th class="border px-4 py-3 whitespace-nowrap">å¤–è³‡</th>
                        <th class="border px-4 py-3 whitespace-nowrap">æŠ•ä¿¡</th>
                        <th class="border px-4 py-3 whitespace-nowrap">è‡ªç‡Ÿå•†</th>
                        <th class="border px-4 py-3 whitespace-nowrap">åˆè¨ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="border px-4 py-8 text-gray-500">
                            è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
  </div>

  <script>
  let records = [];
  let stockList = [];
  let tradingChart;

  // âœ… K ç·šåœ–å°ˆå±¬çš„ç‹€æ…‹ç®¡ç†ç‰©ä»¶
  const klineState = {
      currentStockId: null,
      rawDailyData: [], // å„²å­˜å¾ Kline.json è¼‰å…¥çš„åŸå§‹æ—¥ç·š OHLCV è³‡æ–™
      currentPeriod: 'D', // ç•¶å‰é€±æœŸï¼š'D', 'W', 'M'
      klineChart: null // Lightweight Charts å¯¦ä¾‹
  };

  const klineChartContainer = document.getElementById('klineChartContainer');
  const input = document.getElementById("search-input");
  const suggestions = document.getElementById("suggestions");
  const tableBody = document.querySelector("#trading-table tbody");
  const pageTitle = document.getElementById("page-title");
  const clearBtn = document.getElementById("clear-input-btn");

  const insightsView = document.getElementById('insights-view');
  const stockView = document.getElementById('stock-view');

  function toggleView(view) {
    if (view === 'insights') {
      insightsView.classList.remove('hidden');
      stockView.classList.add('hidden');
      pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
    } else if (view === 'stock') {
      insightsView.classList.add('hidden');
      stockView.classList.remove('hidden');
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleView('insights');
    // åˆå§‹åŒ–é€±æœŸæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨ï¼Œä½†æ­¤æ™‚ rawDailyData ç‚ºç©ºï¼Œéœ€åœ¨è¼‰å…¥è³‡æ–™å¾Œå†æ¬¡å‘¼å«
    setupPeriodButtons(); 
  });

  // (ç•¥é data.json, insights.json, newcomers.json, explosive.json ç›¸é—œé‚è¼¯... ä¿æŒä¸è®Š)

  function createStockLink(stock_id, name) {
    const a = document.createElement("a");
    a.href = `https://www.cmoney.tw/finance/f00025.aspx?s=${stock_id}`;
    a.target = "_blank";
    a.textContent = `${name} (${stock_id})`;
    a.className = "hover:underline text-black";
    return a;
  }

  // --- è¼‰å…¥ data.json å»ºè‚¡ç¥¨æ¸…å–® (ä¿æŒä¸è®Š) ---
  fetch("data.json")
    .then(res => res.json())
    .then(data => {
      records = data.records;
      records.forEach(day => {
        day.stocks.forEach(s => {
          if (!stockList.find(x => x.id === s.stock_id)) {
            stockList.push({ id: s.stock_id, name: s.name.trim() });
          }
        });
      });
    });

  // (ç•¥é insights.json, newcomers.json, explosive.json é‚è¼¯... ä¿æŒä¸è®Š)
  fetch("insights.json").then(res => res.json()).then(data => { /* ... */ });
  fetch("newcomers.json").then(res => res.json()).then(data => { /* ... */ });
  fetch("explosive.json").then(res => res.json()).then(data => { /* ... */ });

  // --- æœå°‹é‚è¼¯ (ä¿æŒä¸è®Š) ---
  input.addEventListener("input", function() {
    if (this.value.trim()) {
      clearBtn.classList.remove("hidden");
    } else {
      clearBtn.classList.add("hidden");
      suggestions.classList.add("hidden");
      toggleView('insights');
    }
    const keyword = this.value.trim();
    suggestions.innerHTML = "";
    if (!keyword) { suggestions.classList.add("hidden"); return; }
    const matched = stockList.filter(s =>
      s.id.includes(keyword) || s.name.includes(keyword)
    ).slice(0, 10);
    if (matched.length === 0) { suggestions.classList.add("hidden"); return; }
    matched.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.name} (${s.id})`;
      li.className = "p-2 hover:bg-gray-100 cursor-pointer";
      li.addEventListener("click", () => {
        input.value = s.id;
        suggestions.classList.add("hidden");
        clearBtn.classList.remove("hidden");
        showStockData(s.id);
      });
      suggestions.appendChild(li);
    });
    suggestions.classList.remove("hidden");
  });

  clearBtn.addEventListener("click", () => {
    input.value = "";
    clearBtn.classList.add("hidden");
    suggestions.classList.add("hidden");
    tableBody.innerHTML = `
      <tr>
        <td colspan="5" class="border px-4 py-8 text-gray-500">
          è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
        </td>
      </tr>
    `;
    toggleView('insights');
    input.focus();
  });

  input.addEventListener("keyup", e => {
    if (e.key === "Enter") {
      const keyword = e.target.value.trim();
      if (keyword) { showStockData(keyword); suggestions.classList.add("hidden"); }
    }
  });

  function showStockData(keyword) {
    // ... (æ³•äººè²·è³£è¶…è¡¨æ ¼å’Œ Chart.js é‚è¼¯ä¿æŒä¸è®Š)
    tableBody.innerHTML = "";
    const colorize = (val) => {
      const num = Number(val);
      const formattedVal = num.toLocaleString();
      if (num > 0) return `<span class="text-red-600">${formattedVal}</span>`;
      if (num < 0) return `<span class="text-green-600">${formattedVal}</span>`;
      return formattedVal;
    };

    const kw = keyword.toString().replace(/\s|ã€€/g, "").trim();
    let foundStock = null;
    let dataFound = false;

    const chartLabels = [];
    const chartForeignData = [];
    const chartInvestData = [];
    const chartDealerData = [];
    const chartTotalData = [];

    // Reverse loop to show latest data first in table, and collect chart data
    for (let i = records.length - 1; i >= 0; i--) { 
      const day = records[i];
      const stock = day.stocks.find(s =>
        s.stock_id.toString().replace(/\s|ã€€/g, "").trim() === kw ||
        s.name.replace(/\s|ã€€/g, "").includes(kw)
      );
      if (stock) {
        dataFound = true;
        if (!foundStock) foundStock = stock;

        const foreign = Math.round(stock.foreign_net/1000);
        const invest  = Math.round(stock.invest_net/1000);
        const dealer  = Math.round(stock.dealer_net/1000);
        const total   = Math.round((stock.foreign_net + stock.invest_net + stock.dealer_net)/1000);

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
          <td class="border px-4 py-2">${day.date}</td>
          <td class="border px-4 py-2">${colorize(foreign)}</td>
          <td class="border px-4 py-2">${colorize(invest)}</td>
          <td class="border px-4 py-2">${colorize(dealer)}</td>
          <td class="border px-4 py-2">${colorize(total)}</td>`;
        tableBody.prepend(tr);

        chartLabels.push(day.date);
        chartForeignData.push(foreign);
        chartInvestData.push(invest);
        chartDealerData.push(dealer);
        chartTotalData.push(total);
      }
    }
    // End ofæ³•äººè²·è³£è¶…è¡¨æ ¼å’Œ Chart.js é‚è¼¯
    
    if (foundStock && dataFound) {
      toggleView('stock');
      pageTitle.textContent = `æ³•äººè²·è³£è¶…æŸ¥è©¢ - ${foundStock.name} (${foundStock.stock_id})`;
      // âœ… å‘¼å«æ–°çš„ K ç·šè³‡æ–™è¼‰å…¥å‡½æ•¸
      fetchAndProcessKlineData(foundStock.stock_id.toString()); 
      updateChart(chartLabels, chartForeignData, chartInvestData, chartDealerData, chartTotalData);
    } else {
      toggleView('insights');
      pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
      const errorRow = document.createElement("tr");
      errorRow.innerHTML = `<td colspan="5" class="border px-4 py-8 text-red-500">æ‰¾ä¸åˆ° ${keyword} çš„æ³•äººè²·è³£è¶…è³‡æ–™ã€‚</td>`;
      tableBody.appendChild(errorRow);
      console.log(`[ğŸ” LOG - Search] æŸ¥è©¢å¤±æ•—æˆ–ç„¡æ³•äººè²·è³£è¶…è³‡æ–™: ${keyword}`);
    }
  }

  function updateChart(labels, foreignData, investData, dealerData, totalData) {
    const ctx = document.getElementById('tradingChart').getContext('2d');
    if (tradingChart) { tradingChart.destroy(); }
    tradingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'å¤–è³‡', data: foreignData, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', tension: 0.3, fill: false },
          { label: 'æŠ•ä¿¡', data: investData, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', tension: 0.3, fill: false },
          { label: 'è‡ªç‡Ÿå•†', data: dealerData, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.5)', tension: 0.3, fill: false },
          { label: 'åˆè¨ˆ', data: totalData, borderColor: 'rgb(153, 102, 255)', backgroundColor: 'rgba(153, 102, 255, 0.5)', tension: 0.3, fill: false, borderWidth: 2 }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { title: { display: true, text: 'æ—¥æœŸ' } }, y: { title: { display: true, text: 'è²·è³£è¶…å¼µæ•¸' } } } }
    });
  }

  const ensureFiniteNumber = (value) => {
      const num = Number(value);
      return (Number.isFinite(num) && num !== null) ? num : 0;
  };


  // --- K ç·šåœ–é‚è¼¯é‡æ§‹ ---

  /**
   * æ ¹æ“šæ—¥æœŸå’Œé€±æœŸç²å–åˆ†çµ„éµ (YYYY-MM-DD, YYYY-WW, YYYY-MM)
   * @param {string} dateString - YYYY-MM-DD æ ¼å¼çš„æ—¥æœŸ
   * @param {string} period - 'D', 'W', 'M'
   * @returns {string} åˆ†çµ„éµ
   */
  function getGroupKey(dateString, period) {
      if (!dateString) return '';
      if (period === 'D') return dateString;

      const [year, month, day] = dateString.split('-').map(Number);
      // Date object assumes local time, use UTC for consistency in calculations
      const date = new Date(Date.UTC(year, month - 1, day));
      if (isNaN(date)) return dateString;

      if (period === 'M') {
          return `${year}-${String(month).padStart(2, '0')}`;
      } 
      
      if (period === 'W') {
          // ISO 8601 Week calculation: week starts on Monday (day=1)
          const d = new Date(date);
          const dayNum = d.getUTCDay() || 7; // Sunday is 0, make it 7
          d.setUTCDate(d.getUTCDate() + 4 - dayNum); // Move to nearest Thursday
          const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
          const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
          return d.getUTCFullYear() + '-' + String(weekNo).padStart(2, '0');
      }
      return dateString;
  }

  /**
   * å°‡æ—¥ç·š OHLCV è³‡æ–™èšåˆç‚ºå‘¨ç·šæˆ–æœˆç·š
   * @param {Array<Object>} dailyData - åŸå§‹æ—¥ç·šè³‡æ–™
   * @param {string} period - 'D', 'W', 'M'
   * @returns {Array<Object>} èšåˆå¾Œçš„ OHLCV è³‡æ–™
   */
  function aggregateData(dailyData, period) {
      if (period === 'D') {
          return dailyData;
      }

      const aggregated = {};

      // ç¢ºä¿è³‡æ–™æŒ‰æ™‚é–“æ’åºï¼Œä»¥ä¾¿æ­£ç¢ºè¨ˆç®— Open/Close
      const sortedData = [...dailyData].sort((a, b) => (a.time > b.time ? 1 : -1));

      sortedData.forEach(item => {
          const key = getGroupKey(item.time, period);
          const date = item.time;
          const volume = ensureFiniteNumber(item.value);

          if (!aggregated[key]) {
              // ç¬¬ä¸€å¤©ï¼šOpen, High, Low, Close éƒ½æ˜¯ç•¶å¤©çš„
              aggregated[key] = {
                  time: date,
                  open: item.open,
                  high: item.high,
                  low: item.low,
                  close: item.close,
                  value: volume,
              };
          } else {
              // å¾ŒçºŒå¤©æ•¸ï¼šOpen ä¿æŒä¸è®Šï¼ŒHigh/Low å–æ¥µå€¼ï¼ŒClose æ›´æ–°ç‚ºæœ€æ–°ï¼ŒVolume ç´¯åŠ 
              const current = aggregated[key];
              current.high = Math.max(current.high, item.high);
              current.low = Math.min(current.low, item.low);
              current.close = item.close; // ä¿æŒæœ€æ–°çš„ Close
              current.value += volume;
              current.time = date; // Lightweight Charts ä»¥é€™å€‹ time ä½œç‚º bar çš„æ™‚é–“
          }
      });

      // è½‰æ›å› Lightweight Charts æ ¼å¼
      return Object.values(aggregated);
  }

  /**
   * è¨­å®šé€±æœŸæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
   */
  function setupPeriodButtons() {
      document.querySelectorAll('.period-btn').forEach(button => {
          // æ¸…é™¤èˆŠçš„äº‹ä»¶ç›£è½ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
          button.removeEventListener('click', handlePeriodButtonClick); 
          button.addEventListener('click', handlePeriodButtonClick);
      });
  }

  /**
   * è™•ç†é€±æœŸæŒ‰éˆ•é»æ“Šäº‹ä»¶
   * @param {Event} e 
   */
  function handlePeriodButtonClick(e) {
      const period = e.target.dataset.period;
      if (period && period !== klineState.currentPeriod) {
          updateKlineChart(period);
      }
  }

  /**
   * æ›´æ–° K ç·šåœ–ï¼ŒåŒ…æ‹¬åˆ‡æ›é€±æœŸã€èšåˆè³‡æ–™å’Œé‡æ–°ç¹ªè£½åœ–è¡¨
   * @param {string} newPeriod - 'D', 'W', 'M'
   */
  function updateKlineChart(newPeriod) {
      // æ›´æ–°æŒ‰éˆ•çš„æ´»èºç‹€æ…‹
      document.querySelectorAll('.period-btn').forEach(btn => {
          if (btn.dataset.period === newPeriod) {
              btn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
              btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
          } else {
              btn.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600');
              btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
          }
      });

      if (klineState.rawDailyData.length === 0) {
          klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">ç„¡ K ç·šè³‡æ–™å¯ä¾›é¡¯ç¤ºã€‚</div>`;
          return;
      }

      klineState.currentPeriod = newPeriod;
      
      // èšåˆè³‡æ–™
      const aggregatedData = aggregateData(klineState.rawDailyData, newPeriod);

      // æ¸²æŸ“/é‡ç¹ªåœ–è¡¨
      renderKlineChart(aggregatedData);
  }


  /**
   * ç²å–ä¸¦è™•ç† K ç·šåŸå§‹æ—¥ç·šè³‡æ–™
   * @param {string} stockId - è‚¡ç¥¨ä»£ç¢¼
   * @param {string} initialPeriod - åˆå§‹é€±æœŸï¼Œé è¨­ç‚º 'D'
   */
  function fetchAndProcessKlineData(stockId, initialPeriod = 'D') {
      if (!klineChartContainer || !stockId) return;

      klineState.currentStockId = stockId;
      klineState.rawDailyData = [];
      klineState.currentPeriod = initialPeriod;
      klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">Kç·šè³‡æ–™è¼‰å…¥ä¸­...</div>`;

      if (klineState.klineChart) {
          try { klineState.klineChart.remove(); } catch (e) {}
          klineState.klineChart = null;
      }

      // é‡è¨­æŒ‰éˆ•ç‹€æ…‹ç‚ºæ—¥ç·š
      updateKlineChart(initialPeriod);

      fetch("Kline.json")
          .then(res => {
              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
              return res.json();
          })
          .then(klineData => {
              let filteredData = [];

              if (klineData && klineData[stockId]) {
                  filteredData = klineData[stockId];
              } else if (Array.isArray(klineData.stocks)) {
                  filteredData = klineData.stocks.filter(item => String(item.stock_id) === String(stockId));
              }

              if (!filteredData || filteredData.length === 0) {
                  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾ä¸åˆ° ${stockId} çš„ K ç·šè³‡æ–™ã€‚</div>`;
                  return;
              }

              const chartData = [];
              filteredData.forEach((item) => {
                  const validOpen   = ensureFiniteNumber(item.open);
                  const validHigh   = ensureFiniteNumber(item.high);
                  const validLow    = ensureFiniteNumber(item.low);
                  const validClose  = ensureFiniteNumber(item.close);
                  const validVolume = ensureFiniteNumber(item.volume);

                  if (validOpen === 0 || validHigh === 0 || validLow === 0 || validClose === 0) return;

                  const dateStr = (item.date || item.Date || item.trade_date || "").toString();
                  if (!dateStr) return;

                  chartData.push({
                      time: dateStr, 
                      open: validOpen,
                      high: validHigh,
                      low: validLow,
                      close: validClose,
                      value: validVolume 
                  });
              });

              if (chartData.length === 0) {
                  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾åˆ°åŸå§‹è³‡æ–™ï¼Œä½†ç„¡æ³•ç¹ªè£½æœ‰æ•ˆ K ç·šã€‚</div>`;
                  return;
              }

              // å„²å­˜åŸå§‹æ—¥ç·šè³‡æ–™ï¼Œä¾›å¾ŒçºŒèšåˆä½¿ç”¨
              klineState.rawDailyData = chartData; 
              
              // ç¹ªè£½åˆå§‹åœ–è¡¨ (æ—¥ç·š)
              updateKlineChart(initialPeriod); 
          })
          .catch(error => {
              console.error("[âŒ LOG - Kline] K ç·šåœ–è¼‰å…¥éŒ¯èª¤:", error.message || error);
              klineChartContainer.innerHTML = `<div class="text-center py-4 text-red-500">K ç·šåœ–è¼‰å…¥éŒ¯èª¤: ${error.message}</div>`;
          });
  }

  /**
   * ç¹ªè£½ Lightweight Charts K ç·šåœ–
   * @param {Array<Object>} chartData - ç¶“èšåˆå¾Œçš„ OHLCV è³‡æ–™
   */
  function renderKlineChart(chartData) {
      
      // å¦‚æœåœ–è¡¨å·²ç¶“å­˜åœ¨ï¼Œå…ˆç§»é™¤å®ƒ
      if (klineState.klineChart) {
          try { klineState.klineChart.remove(); } catch (e) {}
          klineState.klineChart = null;
      }
      
      klineChartContainer.innerHTML = "";
      const width = klineChartContainer.parentElement.clientWidth; 

      klineState.klineChart = LightweightCharts.createChart(klineChartContainer, {
          width: width,
          height: 300,
          layout: { backgroundColor: '#ffffff', textColor: '#333' },
          grid: {
              vertLines: { color: '#e0e0e0' },
              horzLines: { color: '#e0e0e0' }
          },
          timeScale: {
              timeVisible: true,
              secondsVisible: false,
              // âœ… èª¿æ•´æ™‚é–“è»¸åˆ»åº¦æ ¼å¼
              tickMarkFormatter: (time, tickMarkType) => {
                  // Lightweight Charts å‚³å…¥çš„ 'time' å¯èƒ½æ˜¯ timestamp (ç§’) æˆ– YYYY-MM-DD å­—ä¸²
                  let dateStr;
                  if (typeof time === 'number') {
                      // è½‰æ› timestamp (ç§’) ç‚º YYYY-MM-DD
                      const date = new Date(time * 1000); 
                      // ç¢ºä¿æ™‚å€æ­£ç¢ºï¼Œé€™è£¡ä½¿ç”¨ UTC æ™‚é–“ä¾†é¿å…æœ¬åœ°æ™‚å€å•é¡Œ
                      dateStr = date.toISOString().substring(0, 10); 
                  } else {
                      dateStr = String(time);
                  }

                  if (!dateStr || dateStr.length < 7) {
                      return '';
                  }

                  const month = dateStr.substring(5, 7); // MM
                  const year = dateStr.substring(0, 4);  // YYYY

                  // å¹´ä»½äº¤ç•Œæˆ–é€±æœŸç‚ºæœˆç·šæ™‚ï¼Œé¡¯ç¤ºå®Œæ•´çš„å¹´æœˆ
                  if (klineState.currentPeriod === 'M' || tickMarkType === LightweightCharts.TickMarkType.Year) {
                      return year + 'å¹´' + parseInt(month, 10) + 'æœˆ';
                  }
                  
                  // å…¶ä»–æƒ…æ³ (æ—¥ç·š/å‘¨ç·š)ï¼Œåªé¡¯ç¤º 'Xæœˆ'
                  return parseInt(month, 10) + 'æœˆ';
              },
          },
      });

      // K ç·š series
      const candleSeries = klineState.klineChart.addCandlestickSeries({
          upColor: '#ef5350',
          downColor: '#26a69a',
          borderVisible: false,
          wickUpColor: '#ef5350',
          wickDownColor: '#26a69a',
      });
      candleSeries.setData(chartData);

      // èª¿æ•´è‚¡åƒ¹çš„ price scale
      klineState.klineChart.priceScale('right').applyOptions({
          scaleMargins: {
              top: 0.1, 
              bottom: 0.25 
          }
      });

      // æˆäº¤é‡ series
      const volumeSeries = klineState.klineChart.addHistogramSeries({
          priceScaleId: 'volume',
          priceFormat: { type: 'volume' },
      });

      // èª¿æ•´æˆäº¤é‡çš„ price scale
      klineState.klineChart.priceScale('volume').applyOptions({
          scaleMargins: {
              top: 0.75,  
              bottom: 0.05 
          }
      });

      const volumeData = chartData.map(d => ({
          time: d.time,
          value: ensureFiniteNumber(d.value),
          color: d.close >= d.open ? '#ef535099' : '#26a69a99',
      }));
      volumeSeries.setData(volumeData);

      // èª¿æ•´è¦–åœ–
      klineState.klineChart.timeScale().fitContent();
  }

  // çª—å£å¤§å°æ”¹è®Šæ™‚ï¼Œèª¿æ•´åœ–è¡¨å¯¬åº¦
  window.addEventListener('resize', () => {
      if (klineState.klineChart && klineChartContainer) {
          const width = klineChartContainer.parentElement.clientWidth; 
          klineState.klineChart.applyOptions({ width });
      }
  });

  </script>
</body>
</html>
