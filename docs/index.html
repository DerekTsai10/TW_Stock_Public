<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三大法人買賣超紀錄查詢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 20px;
      background: #f7f9fb;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #222;
    }
    .search-container {
      text-align: center;
      margin: 20px 0;
    }
    input {
      padding: 8px 12px;
      font-size: 16px;
      width: 200px;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .result {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: right;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
    td:first-child, th:first-child {
      text-align: left;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>三大法人買賣超查詢（近 20 交易日）</h1>

  <div class="search-container">
    <input type="text" id="stockInput" placeholder="輸入股票代號或名稱">
    <button onclick="searchStock()">查詢</button>
  </div>

  <div class="result" id="result">
    <p>請輸入股票代號或名稱進行查詢。</p>
  </div>

  <script>
    let dataRecords = [];

    async function loadData() {
      const response = await fetch("docs/data.json");
      const json = await response.json();
      dataRecords = json.records;
      console.log(`✅ 已載入 ${dataRecords.length} 交易日資料`);
    }

    function searchStock() {
      const input = document.getElementById("stockInput").value.trim();
      const resultDiv = document.getElementById("result");
      if (!input) {
        resultDiv.innerHTML = "<p>請輸入股票代號或名稱。</p>";
        return;
      }

      // 搜尋該股票在所有日期的紀錄
      let stockHistory = [];
      for (const day of dataRecords) {
        const found = day.stocks.find(s => 
          s.stock_id === input || s.name.trim() === input
        );
        if (found) {
          stockHistory.push({
            date: day.date,
            ...found
          });
        }
      }

      if (stockHistory.length === 0) {
        resultDiv.innerHTML = `<p>查無「${input}」相關紀錄。</p>`;
        return;
      }

      // 按日期排序（由舊到新）
      stockHistory.sort((a, b) => a.date.localeCompare(b.date));

      // 顯示表格
      let tableHTML = `
        <h2>${stockHistory[0].name.trim()}（${stockHistory[0].stock_id}）</h2>
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>外資淨買超</th>
              <th>投信淨買超</th>
              <th>外本比(%)</th>
              <th>投本比(%)</th>
            </tr>
          </thead>
          <tbody>
      `;

      stockHistory.forEach(item => {
        tableHTML += `
          <tr>
            <td>${item.date}</td>
            <td style="color:${item.foreign_net>=0?'red':'green'}">${item.foreign_net.toLocaleString()}</td>
            <td style="color:${item.invest_net>=0?'red':'green'}">${item.invest_net.toLocaleString()}</td>
            <td>${item.foreign_ratio.toFixed(4)}</td>
            <td>${item.invest_ratio.toFixed(4)}</td>
          </tr>
        `;
      });

      tableHTML += "</tbody></table>";

      // 建立折線圖
      const labels = stockHistory.map(d => d.date);
      const foreignData = stockHistory.map(d => d.foreign_net);
      const investData = stockHistory.map(d => d.invest_net);

      const chartHTML = `<div class="chart-container"><canvas id="trendChart"></canvas></div>`;
      resultDiv.innerHTML = tableHTML + chartHTML;

      const ctx = document.getElementById("trendChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "外資淨買超",
              data: foreignData,
              borderColor: "red",
              fill: false
            },
            {
              label: "投信淨買超",
              data: investData,
              borderColor: "blue",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
            x: { ticks: { autoSkip: true, maxTicksLimit: 10 } }
          }
        }
      });
    }

    loadData();
  </script>
</body>
</html>
