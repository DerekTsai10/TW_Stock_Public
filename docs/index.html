<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">
  <title>æ³•äººè²·è³£è¶…æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    /* âœ… æ¡Œæ©Ÿç¶­æŒåŸæœ¬ scale-150ï¼ˆç”¨ transformï¼‰ */
    .desktop-zoom {
      transform: scale(1.5);
      transform-origin: top center;
    }

    /* âœ… åªè®“ lightweight-charts çš„å¤–æ¡†ã€Œè¦–è¦ºä¸Šä¸åƒ scaleã€ */
    .no-scale-chart {
      width: 150%;
      transform: scale(0.6666667);
      transform-origin: top left;
    }

    @media (max-width: 768px) {
      .mobile-reset { transform: scale(1) !important; padding: 1rem !important; }
      .mobile-col { grid-template-columns: 1fr !important; gap: 1.5rem !important; }
      .mobile-center { text-align: center !important; }
      input, select, button { font-size: 1rem; padding: 0.6rem 0.8rem; }
      h1 { font-size: 1.8rem; }
      h3 { font-size: 1.5rem; }

      /* âœ… æ‰‹æ©Ÿä¸è¦ç¸®æ”¾ï¼Œä¹Ÿä¸è¦åç¸®æ”¾ */
      .desktop-zoom { transform: none !important; }
      .no-scale-chart { width: 100% !important; transform: none !important; }
    }
    #suggestions { z-index: 20; }
    #clear-input-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.15s;
    }
    #clear-input-btn:hover {
      color: #6b7280;
    }
  </style>
</head>

<body class="p-6 bg-gray-50 text-lg">
  <div class="max-w-7xl mx-auto desktop-zoom mobile-reset transition-transform duration-300">

    <!-- ğŸ· æ¨™é¡Œ + å°æŒ‡æœŸçµç®—æé†’æŒ‰éˆ• -->
    <div class="flex items-center justify-between mb-4">
      <h1 id="page-title" class="text-3xl font-bold mobile-center">
        æ³•äººè²·è³£è¶…æŸ¥è©¢
      </h1>
            <!-- VIX æŒ‡æ¨™ + å°æŒ‡æœŸçµç®—æé†’æŒ‰éˆ• -->
      <div class="flex items-center space-x-2">
        <!-- VIX æŒ‡æ•¸æç¤ºï¼šé¡è‰²æœƒä¾ VIX å€é–“è®ŠåŒ– -->
        <button
          id="vixBadge"
          type="button"
          class="inline-flex items-center px-4 py-1 rounded-full bg-gray-300 text-gray-900 text-xs md:text-sm font-bold shadow cursor-pointer hover:bg-gray-400 transition"
          title="VIX å¸‚å ´ææ…ŒæŒ‡æ¨™"
          onclick="openVixModal()"
        >
          VIX --
        </button>
      <button
        id="txReminderBtn"
        type="button"
        class="ml-3 inline-flex items-center px-3 py-1 rounded-full bg-yellow-300 text-xs md:text-sm font-bold text-gray-800 shadow cursor-pointer hover:bg-yellow-400 transition"
        title="å°æŒ‡æœŸçµç®—æ—¥æé†’"
        style="display: none;"
      >
        T-?
      </button>      </div>

    </div>

    <!-- ğŸ” é ‚éƒ¨å°è¦½åˆ—ï¼šè§€å¯Ÿæ¸…å–® / å€‹è‚¡æŸ¥è©¢ -->
    <div class="mb-6 border-b">
      <nav class="flex space-x-4">
        <button
          id="tab-insights"
          type="button"
          class="px-4 py-2 text-sm font-medium border-b-2 -mb-px text-blue-600 border-blue-500">
          è§€å¯Ÿæ¸…å–®
        </button>
        <button
          id="tab-stock"
          type="button"
          class="px-4 py-2 text-sm font-medium border-b-2 -mb-px text-gray-500 border-transparent hover:text-blue-600">
          å€‹è‚¡æŸ¥è©¢
        </button>
      </nav>
    </div>

    <div class="my-6 flex flex-col md:flex-row md:items-center md:space-x-3 relative w-full md:w-full mx-auto md:mx-0">
      <label for="search-input" class="font-bold text-xl mb-2 md:mb-0 whitespace-nowrap mobile-center">
        è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼š
      </label>
      <div class="relative w-full md:w-80">
        <input type="text" id="search-input"
               placeholder="å°ç©é›» æˆ– 2330"
               class="w-full border p-3 rounded text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
               autocomplete="off"
               autofocus>
        <button id="clear-input-btn" class="absolute hidden focus:outline-none" title="æ¸…é™¤è¼¸å…¥">
            &times;
        </button>
        <ul id="suggestions"
            class="absolute w-full bg-white border rounded mt-1 shadow-lg hidden max-h-60 overflow-y-auto z-20 text-lg"></ul>
      </div>
      <div id="industry-tags-inline"
           class="flex flex-wrap gap-2 mt-4 md:mt-0 md:ml-6 text-sm"></div>
    </div>

    <!-- ğŸ” è§€å¯Ÿæ¸…å–®è¦–åœ– -->
    <div id="insights-view">
      <div class="grid grid-cols-2 gap-6 mb-8 mobile-col">
        <div class="p-6 border rounded bg-white shadow">
          <!-- ğŸ“Š æ¨™é¡Œ + åˆ·æ–°æŒ‰éˆ• -->
          <div class="flex items-center justify-between mb-6">
            <h3 id="insights-title" class="font-bold text-2xl mobile-center">ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–®</h3>
            <button
              id="refresh-insights-btn"
              type="button"
              class="text-sm px-3 py-1 rounded border text-gray-600 hover:bg-gray-100">
              ğŸ”„ åˆ·æ–°
            </button>
          </div>

          <h4 class="font-bold text-xl mb-3">ğŸ—“ï¸ ç•¶æ—¥å¤–/æŠ•æœ¬æ¯”å‰ 10</h4>
          <div class="grid grid-cols-2 gap-6 text-gray-700">
            <div>
              <h5 class="font-semibold mb-2 text-base">ğŸŒ å¤–è³‡</h5>
              <ul id="foreign_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
            </div>
            <div>
              <h5 class="font-semibold mb-2 text-base">ğŸ¦ æŠ•ä¿¡</h5>
              <ul id="invest_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
            </div>
          </div>
          <div id="period-section" class="mt-8"></div>
        </div>

        <div class="p-6 border rounded bg-white shadow">
          <div class="grid grid-cols-2 gap-6 mobile-col">
            <div>
              <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸš€ æ–°ä¸Šæ¦œ</h3>
              <div id="newcomers-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
            </div>
            <div>
              <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸ”¥ çˆ†é‡åµæ¸¬</h3>
              <div id="explosive-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ“ˆ å€‹è‚¡è¦–åœ– -->
    <div id="stock-view" class="hidden">
        <!-- ğŸ§  æ³•äººæ‘˜è¦å°å¡ï¼šé€£çºŒè²·è¶… + è¿‘5/10æ—¥ç´¯è¨ˆ -->
        <div id="chip-summary" class="mb-6 text-base text-gray-700 bg-gray-50 rounded px-4 py-3">
          <div class="text-gray-400">
            è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼Œä»¥é¡¯ç¤ºæ³•äººé€£çºŒè²·è¶…èˆ‡è¿‘ 5 / 10 æ—¥ç´¯è¨ˆè³‡è¨Šã€‚
          </div>
        </div>

        <div id="kline-chart-wrapper" class="pt-2 px-3 pb-2 border rounded bg-white shadow mb-6">
            <h3 class="font-bold text-2xl mb-4 mobile-center">è‚¡åƒ¹ K ç·šåœ–</h3>

            <div id="klineChartContainer" class="relative no-scale-chart" style="height: 720px;">
                <div class="text-center py-4 text-gray-500">è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±æœå°‹ï¼Œä»¥é¡¯ç¤º K ç·šåœ–ã€‚</div>
            </div>

            <div id="kline-ma-legend" class="mt-1 text-base text-gray-600 flex items-center space-x-4 mobile-center flex-wrap">
              <div class="flex items-center space-x-2">
                <span class="inline-block w-6 h-1 rounded" style="background:#f59e0b;"></span>
                <span>5MAï¼ˆæ©˜è‰²ï¼‰</span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="inline-block w-6 h-1 rounded" style="background:#8b5cf6;"></span>
                <span>10MAï¼ˆç´«è‰²ï¼‰</span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="inline-block w-6 h-1 rounded" style="background:#3b82f6;"></span>
                <span>20MAï¼ˆè—è‰²ï¼‰</span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="inline-block w-6 h-1 rounded" style="background:#10b981;"></span>
                <span>60MAï¼ˆç¶ è‰²ï¼‰</span>
              </div>
            </div>
        </div>

        <div id="chart-container" class="p-6 border rounded bg-white shadow mb-8">
            <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶…è¶¨å‹¢åœ– (Chart.js)</h3>
            <div class="relative h-96">
                <canvas id="tradingChart"></canvas>
            </div>
        </div>

        <div class="p-6 border rounded bg-white shadow overflow-x-auto">
            <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶… (å¼µ)</h3>
            <table id="trading-table" class="min-w-full text-center border-collapse border text-lg">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
                        <th class="border px-4 py-3 whitespace-nowrap">å¤–è³‡</th>
                        <th class="border px-4 py-3 whitespace-nowrap">æŠ•ä¿¡</th>
                        <th class="border px-4 py-3 whitespace-nowrap">è‡ªç‡Ÿå•†</th>
                        <th class="border px-4 py-3 whitespace-nowrap">åˆè¨ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="border px-4 py-8 text-gray-500">
                            è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
  </div>

  <!-- ğŸ§¾ å°æŒ‡æœŸçµç®—æé†’ Modalï¼ˆæ”¹ç‚ºå³ä¸Šè§’ï¼‰ -->
  
  <!-- VIX å¸‚å ´ææ…ŒæŒ‡æ¨™ Modal -->
  <div
    id="vixModal"
    class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-start justify-end pt-24 pr-6"
  >
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-5 md:p-6">
      <div class="flex items-start justify-between mb-3">
        <h2 class="text-xl md:text-2xl font-semibold">VIX å¸‚å ´ææ…ŒæŒ‡æ¨™</h2>
        <button
          id="vixClose"
          class="text-gray-400 hover:text-gray-600 text-2xl leading-none"
        >
          Ã—
        </button>
      </div>

      <p id="vixValueText" class="text-xl md:text-2xl text-gray-700 leading-relaxed mb-3">
        ç›®å‰ VIXï¼š-- 
      </p>

      <ul class="text-lg text-gray-600 list-disc list-inside space-y-1">
        <li><span class="font-semibold text-green-600">ç¶ è‰²ï¼ˆVIX &lt; 20ï¼‰</span>ï¼šå¸‚å ´å¹³ç©©ã€‚</li>
        <li><span class="font-semibold text-gray-700">ç°è‰²ï¼ˆ20 â‰¤ VIX &lt; 28.7ï¼‰</span>ï¼šæ­¤æ™‚è²·é€²æœªä¾† 12 å€‹æœˆçš„æŠ•è³‡å ±é…¬ç‡å…¶å¯¦éå¸¸å·®ï¼Œç”šè‡³æ¯” VIX ä½æ–¼ 20 é‚„å·®ã€‚</li>
        <li><span class="font-semibold text-yellow-600">æ©˜è‰²ï¼ˆ28.7 â‰¤ VIX &lt; 33.5ï¼‰</span>ï¼šæ­¤æ™‚è²·é€²æœªä¾† 12 å€‹æœˆçš„å¹³å‡å ±é…¬ç´„å¯é” 15%ã€‚</li>
        <li><span class="font-semibold text-red-600">ç´…è‰²ï¼ˆVIX â‰¥ 33.5ï¼‰</span>ï¼šæ­¤æ™‚è²·é€²æœªä¾† 12 å€‹æœˆçš„å¹³å‡å ±é…¬ç´„å¯é” 25%ã€‚</li>
      </ul>
    </div>
  </div>

<div
    id="txReminderModal"
    class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-start justify-end pt-24 pr-6"
  >
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-5 md:p-6">
      <div class="flex items-start justify-between mb-3">
        <h2 class="text-xl md:text-2xl font-semibold">å°æŒ‡æœŸçµç®—æ—¥æé†’</h2>
        <button
          id="txReminderClose"
          class="text-gray-400 hover:text-gray-600 text-2xl leading-none"
        >
          Ã—
        </button>
      </div>

      <!-- å¤§å¤§çš„ T-XX -->
      <p id="txReminderTLabel" class="text-2xl md:text-3xl font-bold text-yellow-600 mb-3">
        T-?
      </p>

      <p class="text-xl md:text-2xl text-gray-700 leading-relaxed mb-1">
        ä¸‹ä¸€æ¬¡å°æŒ‡æœŸçµç®—æ—¥ï¼š
        <span id="txSettlementDate" class="font-semibold"></span>
      </p>
      <p id="txReminderText" class="text-xl md:text-2xl text-gray-800 font-medium mb-3"></p>

      <ul class="text-lg text-gray-600 list-disc list-inside space-y-1">
        <li>å°æŒ‡æœŸç›®å‰è¦å‰‡ç‚ºã€Œæ¯æœˆç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰ã€ç‚ºçµç®—æ—¥ã€‚</li>
        <li>æé†’å€é–“ç›®å‰è¨­å®šç‚ºçµç®—æ—¥å‰ 25 å€‹å·¥ä½œæ—¥å…§ï¼ˆT-25 ï½ Tï¼‰ï¼Œä¹‹å¾Œå¯è‡ªè¡Œèª¿æ•´ã€‚</li>
        <li>æ­¤è™•å…ˆç°¡åŒ–ç‚ºæ’é™¤é€±å…­ã€é€±æ—¥çš„å·¥ä½œæ—¥æ¦‚å¿µï¼Œæœªå«åœ‹å®šå‡æ—¥ã€‚</li>
      </ul>
    </div>
  </div>

  <script>


  // ğŸ“ˆ VIX æŒ‡æ•¸ç›¸é—œé‚è¼¯ï¼ˆå‰ç«¯ç›´æ¥å¾ Yahoo Finance å–å¾—ï¼‰
  async function fetchVIX() {
    try {
      const url = "https://query1.finance.yahoo.com/v8/finance/chart/^VIX?interval=1d";
      const resp = await fetch(url);
      const json = await resp.json();
      let vix = null;

      if (json.chart && json.chart.result && json.chart.result[0] && json.chart.result[0].meta && json.chart.result[0].meta.regularMarketPrice) {
        vix = json.chart.result[0].meta.regularMarketPrice;
      } else if (json.chart && json.chart.result && json.chart.result[0] && json.chart.result[0].indicators && json.chart.result[0].indicators.quote && json.chart.result[0].indicators.quote[0] && json.chart.result[0].indicators.quote[0].close && json.chart.result[0].indicators.quote[0].close[0]) {
        vix = json.chart.result[0].indicators.quote[0].close[0];
      }

      if (!vix) return;
      updateVixBadge(vix);
    } catch (e) {
      console.error("VIX å–å¾—å¤±æ•—", e);
    }
  }

  function getVixColorClass(vix) {
    if (vix < 20) return "bg-green-400 text-white";
    if (vix < 28.7) return "bg-gray-300 text-gray-900";
    if (vix < 33.5) return "bg-yellow-400 text-gray-900";
    return "bg-red-500 text-white";
  }

  function updateVixBadge(vix) {
    const badge = document.getElementById("vixBadge");
    if (!badge) return;
    badge.textContent = "VIX: " + vix.toFixed(1);

    const baseClasses = "inline-flex items-center px-4 py-1 rounded-full text-xs md:text-sm font-bold shadow cursor-pointer hover:bg-opacity-90 transition ";
    badge.className = baseClasses + getVixColorClass(vix);

    const info = document.getElementById("vixValueText");
    if (info) {
      let rangeText = "";
      if (vix < 20) rangeText = "ï¼ˆVIX < 20ï¼Œç¶ è‰²å€é–“ï¼‰";
      else if (vix < 28.7) rangeText = "ï¼ˆ20 â‰¤ VIX < 28.7ï¼Œç°è‰²å€é–“ï¼‰";
      else if (vix < 33.5) rangeText = "ï¼ˆ28.7 â‰¤ VIX < 33.5ï¼Œæ©˜è‰²å€é–“ï¼‰";
      else rangeText = "ï¼ˆVIX â‰¥ 33.5ï¼Œç´…è‰²å€é–“ï¼‰";
      info.textContent = "ç›®å‰ VIXï¼šç´„ " + vix.toFixed(1) + " " + rangeText;
    }
  }

  function openVixModal() {
    const modal = document.getElementById("vixModal");
    if (modal) modal.classList.remove("hidden");
  }

  function closeVixModal() {
    const modal = document.getElementById("vixModal");
    if (modal) modal.classList.add("hidden");
  }

  function initVixWidget() {
    fetchVIX();
    const closeBtn = document.getElementById("vixClose");
    if (closeBtn) closeBtn.addEventListener("click", closeVixModal);
    const modal = document.getElementById("vixModal");
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeVixModal();
      });
    }
  }

  let industryTags = {};
  fetch("industry_tags.json")
    .then(r => r.json())
    .then(d => industryTags = d);

  function renderIndustryTagsBlock(stockId) {
    const data = industryTags[stockId];
    if (!data) return "";
    const tags = [];
    if (Array.isArray(data.themes)) tags.push(...data.themes);
    if (Array.isArray(data.ai_chain)) tags.push(...data.ai_chain);
    if (data.sector_lv2) tags.push(data.sector_lv2);
    if (tags.length===0) return "";
    const maxVisible=4;
    const vis=tags.slice(0,maxVisible);
    const hid=tags.slice(maxVisible);
    let html = `<div class="flex flex-wrap gap-2 mt-2">`;
    vis.forEach(t=> html+=`<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs whitespace-nowrap">${t}</span>`);
    if (hid.length>0){
      html+=`<button id="industry-expand-btn" class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs" onclick="toggleIndustryTags(true)">+${hid.length}</button>`;
    }
    html+=`</div>`;
    html+=`<div id="industry-tags-hidden" class="hidden mt-2 flex flex-wrap gap-2">`;
    hid.forEach(t=> html+=`<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs whitespace-nowrap">${t}</span>`);
    if (hid.length>0){
      html+=`<button class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs" onclick="toggleIndustryTags(false)">- æ”¶åˆ</button>`;
    }
    html+=`</div>`;
    return html;
  }

  function toggleIndustryTags(expand){
    const hid=document.getElementById("industry-tags-hidden");
    const btn=document.getElementById("industry-expand-btn");
    if(!hid) return;
    if(expand){
      hid.classList.remove("hidden");
      if(btn) btn.classList.add("hidden");
    } else {
      hid.classList.add("hidden");
      if(btn) btn.classList.remove("hidden");
    }
  }

  let records = [];
  let stockList = [];
  let tradingChart;

  const klineChartContainer = document.getElementById('klineChartContainer');
  let klineChart = null;

  const input = document.getElementById("search-input");
  const suggestions = document.getElementById("suggestions");
  const tableBody = document.querySelector("#trading-table tbody");
  const pageTitle = document.getElementById("page-title");
  const clearBtn = document.getElementById("clear-input-btn");

  const insightsView = document.getElementById('insights-view');
  const stockView = document.getElementById('stock-view');

  const tabInsights = document.getElementById('tab-insights');
  const tabStock = document.getElementById('tab-stock');
  const refreshInsightsBtn = document.getElementById('refresh-insights-btn');

  const chipSummary = document.getElementById('chip-summary');

  /* ğŸ¯ å°æŒ‡æœŸçµç®—æé†’ç›¸é—œå‡½å¼ */

  // è¨­å®šæé†’çª—å£ï¼šç›®å‰ç‚ºã€Œçµç®—æ—¥å‰ 25 å€‹å·¥ä½œæ—¥å…§ã€
  // è‹¥ä¹‹å¾Œè¦æ”¹æˆ T-5ï¼Œåªè¦æŠŠ 25 æ”¹æˆ 5 å³å¯
  const REMINDER_WINDOW = 25;

  // è¨ˆç®—æŸå¹´æŸæœˆ(0-based)çš„ç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰
  function getThirdWednesday(year, monthIndex) {
    const firstDay = new Date(year, monthIndex, 1);
    const firstDayWeek = firstDay.getDay(); // 0=Sun..3=Wed..6=Sat
    const offsetToWed = (3 - firstDayWeek + 7) % 7; // ç¬¬ä¸€æ¬¡é‡åˆ°é€±ä¸‰éœ€è¦å¾€å¾Œæ¨å¹¾å¤©
    const thirdWedDate = 1 + offsetToWed + 14;       // ç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰ = ç¬¬ä¸€å€‹ + 14 å¤©
    return new Date(year, monthIndex, thirdWedDate);
  }

  // å¾æŒ‡å®šæ—¥æœŸé–‹å§‹ï¼Œå–å¾—ã€Œä¸‹ä¸€å€‹å°æŒ‡æœŸçµç®—æ—¥ã€ï¼ˆæ¯æœˆç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰ï¼Œå«è·¨å¹´ï¼‰
  function getNextSettlementDate(fromDate) {
    let year = fromDate.getFullYear();
    let month = fromDate.getMonth(); // 0-based

    let candidate = getThirdWednesday(year, month);

    // å¦‚æœä»Šå¤©å·²ç¶“è¶…éæœ¬æœˆçš„ç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰ï¼Œå°±çœ‹ä¸‹å€‹æœˆ
    if (fromDate > candidate) {
      month += 1;
      if (month > 11) {
        month = 0;
        year += 1;
      }
      candidate = getThirdWednesday(year, month);
    }

    return candidate;
  }

  // è¨ˆç®—å…©æ—¥æœŸä¹‹é–“çš„ã€Œå·¥ä½œæ—¥æ•¸ã€ï¼ˆæ’é™¤é€±å…­ã€é€±æ—¥ï¼‰ï¼Œå›å‚³ >=1 çš„æ•´æ•¸ï¼›è‹¥ start > end å‰‡å› 0
  function countBusinessDaysBetween(startDate, endDate) {
    if (startDate > endDate) return 0;
    const cur = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    let count = 0;

    while (cur <= end) {
      const day = cur.getDay(); // 0 Sun, 6 Sat
      if (day !== 0 && day !== 6) {
        count++;
      }
      cur.setDate(cur.getDate() + 1);
    }
    return count;
  }

  function setupTxReminderWidget() {
    const btn = document.getElementById('txReminderBtn');
    const modal = document.getElementById('txReminderModal');
    const closeBtn = document.getElementById('txReminderClose');
    const textEl = document.getElementById('txReminderText');
    const dateEl = document.getElementById('txSettlementDate');
    const tLabelEl = document.getElementById('txReminderTLabel');

    if (!btn || !modal || !closeBtn || !textEl || !dateEl || !tLabelEl) return;

    const today = new Date();
    const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    const settlementDate = getNextSettlementDate(todayDate);

    // ä»Šå¤©åˆ°çµç®—æ—¥çš„å·¥ä½œæ—¥æ•¸ï¼ˆåŒ…å«ä»Šå¤©èˆ‡çµç®—æ—¥ï¼‰
    const businessDays = countBusinessDaysBetween(todayDate, settlementDate);
    if (businessDays === 0) {
      btn.style.display = 'none';
      return;
    }

    // T-0: ä»Šå¤©æ˜¯çµç®—æ—¥ â†’ daysLeft = 0
    const daysLeft = businessDays - 1;

    if (daysLeft < 0 || daysLeft > REMINDER_WINDOW) {
      btn.style.display = 'none';
      return;
    }

    // é¡¯ç¤ºæŒ‰éˆ•
    btn.style.display = 'inline-flex';

    // é¡¯ç¤ºçµç®—æ—¥æœŸ (YYYY-MM-DD)
    const y = settlementDate.getFullYear();
    const m = String(settlementDate.getMonth() + 1).padStart(2, '0');
    const d = String(settlementDate.getDate()).padStart(2, '0');
    dateEl.textContent = `${y}-${m}-${d}`;

    if (daysLeft === 0) {
      btn.textContent = 'T';
      tLabelEl.textContent = 'T';
      textEl.textContent = 'ä»Šå¤©æ˜¯å°æŒ‡æœŸçµç®—æ—¥ï¼ˆT æ—¥ï¼‰ã€‚è«‹ç•™æ„ç›¤ä¸­æ³¢å‹•èˆ‡çµç®—åƒ¹å½±éŸ¿ã€‚';
    } else {
      btn.textContent = `T-${daysLeft}`;
      tLabelEl.textContent = `T-${daysLeft}`;
      textEl.textContent = `è·é›¢å°æŒ‡æœŸçµç®—æ—¥é‚„æœ‰ ${daysLeft} å€‹å·¥ä½œæ—¥ï¼ˆT-${daysLeft}ï¼‰ã€‚`;
    }

    // é»æ“ŠæŒ‰éˆ• â†’ é–‹å•Ÿ Modal
    btn.addEventListener('click', () => {
      modal.classList.remove('hidden');
    });

    // é»æ“Šé—œé–‰æŒ‰éˆ• â†’ é—œé–‰ Modal
    closeBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    // é»æ“ŠèƒŒæ™¯å€åŸŸ â†’ é—œé–‰ Modal
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  }

  // æ•¸å­—è‘—è‰²ï¼šæ­£ç´… / è² ç¶ 
  function colorize(val) {
    const num = Number(val);
    const formattedVal = num.toLocaleString();
    if (num > 0) return `<span class="text-red-600">${formattedVal}</span>`;
    if (num < 0) return `<span class="text-green-600">${formattedVal}</span>`;
    return formattedVal;
  }

  function setActiveTab(view) {
    const base = 'px-4 py-2 text-sm font-medium border-b-2 -mb-px';
    if (!tabInsights || !tabStock) return;

    if (view === 'insights') {
      tabInsights.className = base + ' text-blue-600 border-blue-500';
      tabStock.className = base + ' text-gray-500 border-transparent hover:text-blue-600';
    } else {
      tabInsights.className = base + ' text-gray-500 border-transparent hover:text-blue-600';
      tabStock.className = base + ' text-blue-600 border-blue-500';
    }
  }

  function toggleView(view) {
    if (view === 'insights') {
      insightsView.classList.remove('hidden');
      stockView.classList.add('hidden');
      pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
    } else if (view === 'stock') {
      insightsView.classList.add('hidden');
      stockView.classList.remove('hidden');
    }
    setActiveTab(view);
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleView('insights');
    refreshInsights();
    setupTxReminderWidget(); // ğŸ†• å•Ÿå‹•å°æŒ‡æœŸçµç®—æé†’
    initVixWidget(); // ğŸ†• å•Ÿå‹• VIX æç¤º
  });

  if (tabInsights) {
    tabInsights.addEventListener('click', () => {
      toggleView('insights');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  if (tabStock) {
    tabStock.addEventListener('click', () => {
      toggleView('stock');
      input.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // è¼‰å…¥ data.json â†’ å»ºç«‹ stockList èˆ‡ records
  fetch("data.json")
    .then(res => res.json())
    .then(data => {
      records = data.records;
      records.forEach(day => {
        day.stocks.forEach(s => {
          if (!stockList.find(x => x.id === s.stock_id)) {
            stockList.push({ id: s.stock_id, name: s.name.trim() });
          }
        });
      });
    });

  // å‡½å¼: å»ºç«‹è‚¡ç¥¨åç¨±/ä»£ç¢¼çš„å¤–éƒ¨é€£çµ
  function createStockLink(stock_id, name) {
    const a = document.createElement("a");
    a.href = `https://www.cmoney.tw/finance/f00025.aspx?s=${stock_id}`;
    a.target = "_blank";
    a.textContent = `${name} (${stock_id})`;
    a.className = "hover:underline text-black";
    return a;
  }

  // è§€å¯Ÿæ¸…å–®ï¼šä¸» insights
  function loadInsights() {
    fetch("insights.json")
      .then(res => res.json())
      .then(data => {
        if (data.date) {
          document.getElementById("insights-title").textContent =
            `ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–® (è³‡æ–™æ—¥æœŸï¼š${data.date})`;
        } else {
          document.getElementById("insights-title").textContent =
            `ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–®`;
        }

        const dailyForeign = (data.foreign_ratio_ranking || []).slice(0, 10);
        const dailyInvest  = (data.invest_ratio_ranking  || []).slice(0, 10);

        const foreignList = document.getElementById("foreign_ratio_list");
        const investList  = document.getElementById("invest_ratio_list");
        foreignList.innerHTML = "";
        investList.innerHTML  = "";

        const dailyBoth = new Set(
          dailyForeign
            .map(i => i.stock_id)
            .filter(id => dailyInvest.some(j => j.stock_id === id))
        );

        // åç¨±ï¼šé»æ“Šè§¸ç™¼å€‹è‚¡æŸ¥è©¢ï¼›ç™¾åˆ†æ¯”ï¼šå¤–éƒ¨ CMoney
        const renderListItem = (listEl, items, ratioKey, bothSet) => {
          items.forEach(item => {
            const li = document.createElement("li");

            const nameSpan = document.createElement("span");
            nameSpan.textContent = `${item.name} (${item.stock_id})`;
            nameSpan.className = "cursor-pointer underline underline-offset-2 hover:text-blue-600";

            nameSpan.addEventListener("click", () => {
              input.value = item.stock_id;
              suggestions.classList.add("hidden");
              clearBtn.classList.remove("hidden");
              showStockData(item.stock_id);
            });

            const ratioValue = (item[ratioKey] * 100).toFixed(2);
            const ratioLink = document.createElement("a");
            ratioLink.textContent = ` : ${ratioValue}%`;
            ratioLink.href = `https://www.cmoney.tw/finance/f00025.aspx?s=${item.stock_id}`;
            ratioLink.target = "_blank";
            ratioLink.rel = "noopener";
            ratioLink.className = "ml-1 text-gray-700 hover:text-blue-600";

            if (bothSet.has(item.stock_id)) {
              nameSpan.classList.add("text-red-600", "font-bold");
              ratioLink.classList.remove("text-gray-700");
              ratioLink.classList.add("text-red-600", "font-bold", "hover:text-red-800");
            }

            li.appendChild(nameSpan);
            li.appendChild(ratioLink);
            listEl.appendChild(li);
          });
        };

        renderListItem(foreignList, dailyForeign, 'foreign_ratio', dailyBoth);
        renderListItem(investList, dailyInvest, 'invest_ratio', dailyBoth);

        const periodRoot = document.getElementById("period-section");
        periodRoot.innerHTML = ""; // åˆ·æ–°å‰å…ˆæ¸…ç©º

        function buildPeriodBlock(titleHTML, foreignKey, investKey, prefix) {
          const section = document.createElement("div");
          section.className = "mt-6 border-t pt-4";
          section.innerHTML = `
            <h4 class="font-bold text-xl mb-3">${titleHTML}</h4>
            <div class="grid grid-cols-2 gap-6 text-gray-700">
              <div>
                <h5 class="font-semibold mb-2 text-base">ğŸŒ å¤–è³‡</h5>
                <ul id="${prefix}-foreign" class="list-disc pl-6 space-y-2 text-base"></ul>
              </div>
              <div>
                <h5 class="font-semibold mb-2 text-base">ğŸ¦ æŠ•ä¿¡</h5>
                <ul id="${prefix}-invest" class="list-disc pl-6 space-y-2 text-base"></ul>
              </div>
            </div>
          `;
          periodRoot.appendChild(section);

          const fList = (data[foreignKey] || []).slice(0, 10);
          const iList = (data[investKey]  || []).slice(0, 10);

          const both = new Set(
            fList.map(i => i.stock_id).filter(id => iList.some(j => j.stock_id === id))
          );

          const fUl = document.getElementById(`${prefix}-foreign`);
          const iUl = document.getElementById(`${prefix}-invest`);

          renderListItem(fUl, fList, 'foreign_ratio', both);
          renderListItem(iUl, iList, 'invest_ratio', both);
        }

        buildPeriodBlock(
          "ğŸ—“ï¸ è¿‘5æ—¥å¤–/æŠ•æœ¬æ¯”å‰ 10",
          "foreign_ratio_5d_ranking",
          "invest_ratio_5d_ranking",
          "p5d"
        );

        buildPeriodBlock(
          "ğŸ—“ï¸ è¿‘10æ—¥å¤–/æŠ•æœ¬æ¯”å‰ 10",
          "foreign_ratio_10d_ranking",
          "invest_ratio_10d_ranking",
          "p10d"
        );
      });
  }

  // è§€å¯Ÿæ¸…å–®ï¼šæ–°ä¸Šæ¦œ
  function loadNewcomers() {
    fetch("newcomers.json")
      .then(res => res.json())
      .then(data => {
        const newcomers = data.newcomers || {};
        const container = document.getElementById("newcomers-container");
        container.innerHTML = "";

        const addList = (title, items) => {
          if (items && items.length > 0) {
            const header = document.createElement("p");
            header.className = "font-semibold mt-2";
            header.textContent = title;
            container.appendChild(header);

            const ul = document.createElement("ul");
            ul.className = "list-disc pl-6 space-y-1";
            items.slice(0, 10).forEach(stock => {
              const li = document.createElement("li");
              const a = createStockLink(stock.stock_id, stock.name);
              li.appendChild(a);
              ul.appendChild(li);
            });
            container.appendChild(ul);
          }
        };

        addList("ğŸŒ å¤–è³‡æ–°ä¸Šæ¦œï¼š", newcomers.foreign);
        addList("ğŸ¦ æŠ•ä¿¡æ–°ä¸Šæ¦œï¼š", newcomers.invest);
        if ((!newcomers.foreign || newcomers.foreign.length === 0) &&
            (!newcomers.invest || newcomers.invest.length === 0)) {
          container.textContent = "ï¼ˆä»Šæ—¥ç„¡æ–°ä¸Šæ¦œè‚¡ç¥¨ï¼‰";
        }
      })
      .catch(() => {
        document.getElementById("newcomers-container").textContent = "ç„¡æ³•è¼‰å…¥è³‡æ–™";
      });
  }

  // è§€å¯Ÿæ¸…å–®ï¼šçˆ†é‡åµæ¸¬
  function loadExplosive() {
    fetch("explosive.json")
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("explosive-container");
        container.innerHTML = "";

        if (!data || !data.explosive || data.explosive.length === 0) {
          container.textContent = "ï¼ˆä»Šæ—¥ç„¡çˆ†é‡è‚¡ç¥¨ï¼‰";
          return;
        }

        const ul = document.createElement("ul");
        ul.className = "list-disc pl-6 space-y-1";
        data.explosive.slice(0, 10).forEach(stock => {
          const li = document.createElement("li");
          const a = createStockLink(stock.stock_id, stock.name);
          li.appendChild(a);

          const tag = document.createTextNode(` ${stock.tag}`);
          li.appendChild(tag);
          ul.appendChild(li);
        });
        container.appendChild(ul);
      })
      .catch(() => {
        document.getElementById("explosive-container").textContent = "ç„¡æ³•è¼‰å…¥è³‡æ–™";
      });
  }

  // ğŸ”„ ä¸€éµåˆ·æ–°è§€å¯Ÿæ¸…å–®ï¼šå¤–/æŠ•æœ¬æ¯” + æ–°ä¸Šæ¦œ + çˆ†é‡
  function refreshInsights() {
    loadInsights();
    loadNewcomers();
    loadExplosive();
  }

  if (refreshInsightsBtn) {
    refreshInsightsBtn.addEventListener('click', () => {
      refreshInsights();
    });
  }

  // æœå°‹æ¡†è¼¸å…¥ / å»ºè­°æ¸…å–®
  input.addEventListener("input", function() {
    if (this.value.trim()) {
      clearBtn.classList.remove("hidden");
    } else {
      clearBtn.classList.add("hidden");
      suggestions.classList.add("hidden");
      toggleView('insights');
      resetChipSummary();
    }

    const keyword = this.value.trim();
    suggestions.innerHTML = "";
    if (!keyword) { suggestions.classList.add("hidden"); return; }

    const matched = stockList.filter(s =>
      s.id.includes(keyword) || s.name.includes(keyword)
    ).slice(0, 10);

    if (matched.length === 0) { suggestions.classList.add("hidden"); return; }

    matched.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.name} (${s.id})`;
      li.className = "p-2 hover:bg-gray-100 cursor-pointer";
      li.addEventListener("click", () => {
        input.value = s.id;
        suggestions.classList.add("hidden");
        clearBtn.classList.remove("hidden");
        showStockData(s.id);
      });
      suggestions.appendChild(li);
    });
    suggestions.classList.remove("hidden");
  });

  clearBtn.addEventListener("click", () => {
    input.value = "";
    clearBtn.classList.add("hidden");
    suggestions.classList.add("hidden");

    tableBody.innerHTML = `
      <tr>
        <td colspan="5" class="border px-4 py-8 text-gray-500">
          è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
        </td>
      </tr>
    `;

    resetChipSummary();
    toggleView('insights');
    input.focus();
  });

  input.addEventListener("keyup", e => {
    if (e.key === "Enter") {
      const keyword = e.target.value.trim();
      if (keyword) { showStockData(keyword); suggestions.classList.add("hidden"); }
    }
  });

  // ğŸ§  é‡è¨­æ³•äººæ‘˜è¦å¡ç‰‡
  function resetChipSummary() {
    if (!chipSummary) return;
    chipSummary.innerHTML = `
      <div class="text-gray-400">
        è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼Œä»¥é¡¯ç¤ºæ³•äººé€£çºŒè²·è¶…èˆ‡è¿‘ 5 / 10 æ—¥ç´¯è¨ˆè³‡è¨Šã€‚
      </div>
    `;
  }

  // ğŸ§  æ›´æ–°æ³•äººæ‘˜è¦ï¼šé€£çºŒè²·è¶…å¤©æ•¸ + è¿‘5/10æ—¥ç´¯è¨ˆ
  function updateChipSummary(stockId, stockName, history) {
    if (!chipSummary) return;

    if (!history || history.length === 0) {
      resetChipSummary();
      return;
    }

    // history[0] ç‚ºæœ€è¿‘ä¸€å¤©ï¼ˆæˆ‘å€‘å¾æœ€æ–°å¾€å›æƒæï¼‰
    const calcConsecutive = (key) => {
      let count = 0;
      for (let i = 0; i < history.length; i++) {
        if (history[i][key] > 0) count++;
        else break;
      }
      return count;
    };

    const sumDays = (key, days) => {
      let sum = 0;
      for (let i = 0; i < Math.min(days, history.length); i++) {
        sum += history[i][key];
      }
      return sum;
    };

    const foreignConsec = calcConsecutive('foreign');
    const investConsec  = calcConsecutive('invest');
    const dealerConsec  = calcConsecutive('dealer');

    const foreign5  = sumDays('foreign', 5);
    const foreign10 = sumDays('foreign', 10);
    const invest5   = sumDays('invest', 5);
    const invest10  = sumDays('invest', 10);
    const dealer5   = sumDays('dealer', 5);
    const dealer10  = sumDays('dealer', 10);

    chipSummary.innerHTML = `
      <div class="font-semibold mb-1">
        ${stockName} (${stockId}) - æ³•äººè²·è³£è¶…æ‘˜è¦ï¼ˆå–®ä½ï¼šå¼µï¼Œå·²æ›ç®—åƒå¼µï¼‰
      </div>
      <div class="text-sm text-gray-500 mb-2">
        é€£çºŒè²·è¶…å¤©æ•¸ä»¥æœ€è¿‘ä¸€æ—¥å¾€å‰è¨ˆç®—ï¼›è¿‘ 5 / 10 æ—¥ç‚ºåŠ ç¸½è²·è³£è¶…å¼µæ•¸ï¼ˆåƒå¼µå››æ¨äº”å…¥ï¼‰ã€‚
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div class="bgç™½ rounded border px-3 py-2">
          <div class="font-semibold mb-1">ğŸŒ å¤–è³‡</div>
          <div>é€£çºŒè²·è¶…å¤©æ•¸ï¼š<span class="font-mono">${foreignConsec}</span> å¤©</div>
          <div>è¿‘ 5 æ—¥ç´¯è¨ˆï¼š<span class="font-mono">${colorize(foreign5)}</span></div>
          <div>è¿‘ 10 æ—¥ç´¯è¨ˆï¼š<span class="font-mono">${colorize(foreign10)}</span></div>
        </div>
        <div class="bg-white rounded border px-3 py-2">
          <div class="font-semibold mb-1">ğŸ¦ æŠ•ä¿¡</div>
          <div>é€£çºŒè²·è¶…å¤©æ•¸ï¼š<span class="font-mono">${investConsec}</span> å¤©</div>
          <div>è¿‘ 5 æ—¥ç´¯è¨ˆï¼š<span class="font-mono">${colorize(invest5)}</span></div>
          <div>è¿‘ 10 æ—¥ç´¯è¨ˆï¼š<span class="font-mono">${colorize(invest10)}</span></div>
        </div>
        <div class="bg-white rounded border px-3 py-2">
          <div class="font-semibold mb-1">ğŸ› è‡ªç‡Ÿå•†</div>
          <div>é€£çºŒè²·è¶…å¤©æ•¸ï¼š<span class="font-mono">${dealerConsec}</span> å¤©</div>
          <div>è¿‘ 5 æ—¥ç´¯è¨ˆï¼š<span class="font-mono">${colorize(dealer5)}</span></div>
          <div>è¿‘ 10 æ—¥ç´¯è¨ˆï¼š<span class="font-mono">${colorize(dealer10)}</span></div>
        </div>
      </div>
    `;
  }

  // ä¸»æœå°‹ï¼šé¡¯ç¤ºæ³•äººè¡¨æ ¼ / åœ– / æ‘˜è¦ / K ç·š
  function showStockData(keyword) {
    tableBody.innerHTML = "";
    const tagsContainer = document.getElementById("industry-tags-inline");
    if (tagsContainer) {
      tagsContainer.innerHTML = "";
    }
    const kw = keyword.toString().replace(/\s|ã€€/g, "").trim();
    let foundStock = null;
    let dataFound = false;

    const chartLabels = [];
    const chartForeignData = [];
    const chartInvestData = [];
    const chartDealerData = [];
    const chartTotalData = [];

    const history = []; // çµ¦æ³•äººæ‘˜è¦ç”¨ï¼šå¾æœ€è¿‘å¾€å‰

    if (!records || records.length === 0) {
      console.log("[LOG] records å°šæœªè¼‰å…¥å®Œæˆ");
      return;
    }

    for (let i = records.length - 1; i >= 0; i--) {
      const day = records[i];
      const stock = day.stocks.find(s =>
        s.stock_id.toString().replace(/\s|ã€€/g, "").trim() === kw ||
        s.name.replace(/\s|ã€€/g, "").includes(kw)
      );
      if (stock) {
        dataFound = true;
        if (!foundStock) foundStock = stock;

        const foreign = Math.round(stock.foreign_net / 1000);
        const invest  = Math.round(stock.invest_net / 1000);
        const dealer  = Math.round(stock.dealer_net / 1000);
        const total   = Math.round((stock.foreign_net + stock.invest_net + stock.dealer_net) / 1000);

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
          <td class="border px-4 py-2">${day.date}</td>
          <td class="border px-4 py-2">${colorize(foreign)}</td>
          <td class="border px-4 py-2">${colorize(invest)}</td>
          <td class="border px-4 py-2">${colorize(dealer)}</td>
          <td class="border px-4 py-2">${colorize(total)}</td>`;
        tableBody.prepend(tr);

        chartLabels.push(day.date);
        chartForeignData.push(foreign);
        chartInvestData.push(invest);
        chartDealerData.push(dealer);
        chartTotalData.push(total);

        history.push({
          date: day.date,
          foreign,
          invest,
          dealer
        });
      }
    }

    if (foundStock && dataFound) {
      toggleView('stock');
      pageTitle.textContent = `æ³•äººè²·è³£è¶…æŸ¥è©¢ - ${foundStock.name} (${foundStock.stock_id})`;

      // ç”¢æ¥­ / ä¸»é¡Œ Chipsï¼ˆè¼¸å…¥æ¡†å³å´ï¼‰
      const tagsContainer2 = document.getElementById("industry-tags-inline");
      if (tagsContainer2) {
        tagsContainer2.innerHTML = renderIndustryTagsBlock(foundStock.stock_id.toString());
      }

      // æ³•äººæ‘˜è¦
      updateChipSummary(foundStock.stock_id.toString(), foundStock.name, history);

      // K ç·šåœ–
      loadKlineData(foundStock.stock_id.toString());

      // Chart.js è¶¨å‹¢åœ–
      updateChart(chartLabels, chartForeignData, chartInvestData, chartDealerData, chartTotalData);
    } else {
      toggleView('insights');
      resetChipSummary();
      pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
      console.log(`[ğŸ” LOG - Search] æŸ¥è©¢å¤±æ•—æˆ–ç„¡æ³•äººè²·è³£è¶…è³‡æ–™: ${keyword}`);
    }
  }

  function updateChart(labels, foreignData, investData, dealerData, totalData) {
    const ctx = document.getElementById('tradingChart').getContext('2d');

    if (tradingChart) {
      tradingChart.destroy();
    }

    tradingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'å¤–è³‡',
            data: foreignData,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            tension: 0.3,
            fill: false,
          },
          {
            label: 'æŠ•ä¿¡',
            data: investData,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            tension: 0.3,
            fill: false,
          },
          {
            label: 'è‡ªç‡Ÿå•†',
            data: dealerData,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            tension: 0.3,
            fill: false,
          },
          {
            label: 'åˆè¨ˆ',
            data: totalData,
            borderColor: 'rgb(153, 102, 255)',
            backgroundColor: 'rgba(153, 102, 255, 0.5)',
            tension: 0.3,
            fill: false,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: { title: { display: true, text: 'æ—¥æœŸ' } },
          y: { title: { display: true, text: 'è²·è³£è¶…å¼µæ•¸ï¼ˆåƒå¼µï¼‰' } }
        }
      }
    });
  }

  const ensureFiniteNumber = (value) => {
      const num = Number(value);
      return (Number.isFinite(num) && num !== null) ? num : 0;
  };

  function calcMA(data, period) {
      const result = [];
      let sum = 0;
      const q = [];

      for (let i = 0; i < data.length; i++) {
          const close = ensureFiniteNumber(data[i].close);
          q.push(close);
          sum += close;

          if (q.length > period) {
              sum -= q.shift();
          }

          if (q.length === period) {
              const avg = sum / period;
              result.push({
                  time: data[i].time,
                  value: Number(avg.toFixed(4))
              });
          }
      }
      return result;
  }

  function loadKlineData(stockId) {
      if (!klineChartContainer) return;

      klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</div>`;

      if (klineChart) {
          try { klineChart.remove(); } catch (e) {}
          klineChart = null;
      }

      if (typeof LightweightCharts === 'undefined' || typeof LightweightCharts.createChart !== 'function') {
          console.error("[âŒ LOG - Kline] LightweightCharts æœªè¼‰å…¥æˆ–ä¸æ”¯æ´ createChart");
          klineChartContainer.innerHTML = `<div class="text-center py-4 text-red-500">K ç·šç¨‹å¼åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚</div>`;
          return;
      }

      fetch("Kline.json")
          .then(res => {
              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
              return res.json();
          })
          .then(klineData => {
              let filteredData = [];

              if (!Array.isArray(klineData) && klineData[stockId]) {
                  filteredData = klineData[stockId];
              } else if (Array.isArray(klineData)) {
                  filteredData = klineData.filter(item =>
                      String(item.stock_id).replace(/\s|ã€€/g, "") === String(stockId)
                  );
              } else if (Array.isArray(klineData.stocks)) {
                  filteredData = klineData.stocks.filter(item =>
                      String(item.stock_id).replace(/\s|ã€€/g, "") === String(stockId)
                  );
              }

              if (!filteredData || filteredData.length === 0) {
                  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾ä¸åˆ° ${stockId} çš„ K ç·šè³‡æ–™ã€‚</div>`;
                  return;
              }

              const chartData = [];

              filteredData.forEach((item) => {
                  const validOpen   = ensureFiniteNumber(item.open);
                  const validHigh   = ensureFiniteNumber(item.high);
                  const validLow    = ensureFiniteNumber(item.low);
                  const validClose  = ensureFiniteNumber(item.close);
                  const validVolume = ensureFiniteNumber(item.volume);

                  if (validOpen === 0 || validHigh === 0 || validLow === 0 || validClose === 0) return;

                  const dateStr = (item.date || item.Date || item.trade_date || "").toString();
                  if (!dateStr) return;

                  chartData.push({
                      time: dateStr,
                      open: validOpen,
                      high: validHigh,
                      low: validLow,
                      close: validClose,
                      value: validVolume
                  });
              });

              if (chartData.length === 0) {
                  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾åˆ°åŸå§‹è³‡æ–™ï¼Œä½†ç„¡æ³•ç¹ªè£½æœ‰æ•ˆ K ç·šã€‚</div>`;
                  return;
              }

              chartData.sort((a, b) => new Date(a.time) - new Date(b.time));

              klineChartContainer.innerHTML = "";
              const width = klineChartContainer.clientWidth || 600;
              const height = klineChartContainer.clientHeight || 720;

              klineChart = LightweightCharts.createChart(klineChartContainer, {
                  width,
                  height,
                  layout: { backgroundColor: '#ffffff', textColor: '#333' },
                  grid: {
                      vertLines: { color: '#e0e0e0' },
                      horzLines: { color: '#e0e0e0' }
                  },
                  timeScale: {
                      timeVisible: true,
                      secondsVisible: false,
                  },
                  crosshair: {
                      mode: LightweightCharts.CrosshairMode.Normal,
                      vertLine: {
                          width: 1,
                          color: 'rgba(0,0,0,0.3)',
                          style: LightweightCharts.LineStyle.Solid,
                          labelVisible: true,
                      },
                      horzLine: {
                          width: 1,
                          color: 'rgba(0,0,0,0.3)',
                          style: LightweightCharts.LineStyle.Solid,
                          labelVisible: true,
                      },
                  },
              });

              const candleSeries = klineChart.addCandlestickSeries({
                  upColor: '#ef5350',
                  downColor: '#26a69a',
                  borderVisible: false,
                  wickUpColor: '#ef5350',
                  wickDownColor: '#26a69a',
                  lastValueVisible: false,
                  priceLineVisible: false,
              });
              candleSeries.setData(chartData);

              const ma5Series = klineChart.addLineSeries({
                  color: '#f59e0b', lineWidth: 2, priceLineVisible: false, lastValueVisible: false,
              });
              ma5Series.setData(calcMA(chartData, 5));

              const ma10Series = klineChart.addLineSeries({
                  color: '#8b5cf6', lineWidth: 2, priceLineVisible: false, lastValueVisible: false,
              });
              ma10Series.setData(calcMA(chartData, 10));

              const ma20Series = klineChart.addLineSeries({
                  color: '#3b82f6', lineWidth: 2, priceLineVisible: false, lastValueVisible: false,
              });
              ma20Series.setData(calcMA(chartData, 20));

              const ma60Series = klineChart.addLineSeries({
                  color: '#10b981', lineWidth: 2, priceLineVisible: false, lastValueVisible: false,
              });
              ma60Series.setData(calcMA(chartData, 60));

              klineChart.priceScale('right').applyOptions({
                  scaleMargins: { top: 0.02, bottom: 0.18 }
              });

              const volumeSeries = klineChart.addHistogramSeries({
                  priceScaleId: 'volume',
                  priceFormat: { type: 'volume' },
                  lastValueVisible: false,
                  priceLineVisible: false,
              });

              klineChart.priceScale('volume').applyOptions({
                  scaleMargins: { top: 0.82, bottom: 0 }
              });

              const volumeData = chartData.map(d => ({
                  time: d.time,
                  value: ensureFiniteNumber(d.value),
                  color: d.close >= d.open ? '#ef535099' : '#26a69a99',
              }));
              volumeSeries.setData(volumeData);

              const oldTooltip = klineChartContainer.querySelector('.lw-tooltip');
              if (oldTooltip) oldTooltip.remove();

              const tooltip = document.createElement('div');
              tooltip.className = 'lw-tooltip';
              tooltip.style.position = 'absolute';
              tooltip.style.display = 'none';
              tooltip.style.pointerEvents = 'none';
              tooltip.style.zIndex = '50';
              tooltip.style.background = 'rgba(255,255,255,0.95)';
              tooltip.style.border = '1px solid #ccc';
              tooltip.style.borderRadius = '6px';
              tooltip.style.padding = '8px 10px';
              tooltip.style.fontSize = '14px';
              tooltip.style.color = '#111';
              tooltip.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
              tooltip.style.whiteSpace = 'nowrap';
              klineChartContainer.appendChild(tooltip);

              klineChart.subscribeCrosshairMove(param => {
                  if (!param || !param.time || !param.point) {
                      tooltip.style.display = 'none';
                      return;
                  }

                  const point = param.point;
                  const containerWidth = klineChartContainer.clientWidth;
                  const containerHeight = klineChartContainer.clientHeight;

                  if (point.x < 0 || point.x > containerWidth || point.y < 0 || point.y > containerHeight) {
                      tooltip.style.display = 'none';
                      return;
                  }

                  const candle = param.seriesData.get(candleSeries);
                  if (!candle) {
                      tooltip.style.display = 'none';
                      return;
                  }

                  const vol = param.seriesData.get(volumeSeries);
                  const dateStr = param.time;

                  tooltip.innerHTML = `
                    <div style="font-weight:700; margin-bottom:4px;">${dateStr}</div>
                    <div>é–‹ï¼š${candle.open.toFixed(2)}</div>
                    <div>é«˜ï¼š${candle.high.toFixed(2)}</div>
                    <div>ä½ï¼š${candle.low.toFixed(2)}</div>
                    <div>æ”¶ï¼š${candle.close.toFixed(2)}</div>
                    <div style="margin-top:4px; color:#555;">
                      é‡ï¼š${vol ? Number(vol.value).toLocaleString() : '-'}
                    </div>
                  `;

                  const left = Math.min(point.x + 15, containerWidth - tooltip.offsetWidth - 10);
                  const top  = Math.max(point.y - 80, 10);

                  tooltip.style.left = left + 'px';
                  tooltip.style.top  = top + 'px';
                  tooltip.style.display = 'block';
              });

              klineChart.timeScale().fitContent();
          })
          .catch(error => {
              console.error("[âŒ LOG - Kline] K ç·šåœ–è¼‰å…¥éŒ¯èª¤:", error.message || error);
              klineChartContainer.innerHTML = `<div class="text-center py-4 text-red-500">K ç·šåœ–è¼‰å…¥éŒ¯èª¤ï¼Œè«‹æ‰“é–‹ console æŸ¥çœ‹è©³æƒ…ã€‚</div>`;
          });
  }

  window.addEventListener('resize', () => {
      if (klineChart && klineChartContainer) {
          const width = klineChartContainer.clientWidth || 600;
          klineChart.applyOptions({ width });
      }
  });

  </script>
</body>
</html>
