<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>台股法人買賣超</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    select { display: block; margin: 20px auto; padding: 5px; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }
    .pos { color: red; font-weight: bold; }
    .neg { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2 id="title">台股法人買賣超</h2>
  <select id="stockSelect"></select>
  <div id="tableContainer"></div>

  <script>
    let stockData = {};

    async function loadData() {
      const resp = await fetch("data.json?ts=" + new Date().getTime());
      stockData = await resp.json();
      console.log("DEBUG: data.json =", stockData);

      const stockSelect = document.getElementById("stockSelect");

      // 動態建立選單
      Object.keys(stockData).forEach(stock => {
        const name = stockData[stock][0]?.name || stock;
        const opt = document.createElement("option");
        opt.value = stock;
        opt.textContent = `${name} (${stock})`;
        stockSelect.appendChild(opt);
      });

      // 綁定選擇事件
      stockSelect.addEventListener("change", (e) => {
        renderTable(e.target.value);
      });

      // 預設顯示第一檔
      renderTable(stockSelect.value);
    }

    function renderTable(stock) {
      const records = stockData[stock];
      const container = document.getElementById("tableContainer");
      container.innerHTML = "";

      if (!records || records.length === 0) {
        container.textContent = "⚠️ 此股票沒有資料";
        return;
      }

      const name = records[0].name || "";
      const h2 = document.getElementById("title");
      h2.textContent = `${name} (${stock}) - 過去一個月法人買賣超`;

      const table = document.createElement("table");
      table.innerHTML = `
        <tr>
          <th>日期</th>
          <th>外資</th>
          <th>投信</th>
          <th>自營商</th>
          <th>三大法人合計</th>
        </tr>
      `;

      for (const row of records.slice(-20)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.date}</td>
          <td class="${row.foreign >= 0 ? 'pos' : 'neg'}">${row.foreign}</td>
          <td class="${row.trust >= 0 ? 'pos' : 'neg'}">${row.trust}</td>
          <td class="${row.dealer >= 0 ? 'pos' : 'neg'}">${row.dealer}</td>
          <td class="${row.total >= 0 ? 'pos' : 'neg'}">${row.total}</td>
        `;
        table.appendChild(tr);
      }

      container.appendChild(table);
    }

    loadData();
  </script>
</body>
</html>
