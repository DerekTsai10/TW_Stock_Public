<script>
  let stockData = [];
  let stockNames = {};
  let epsData = {};
  let newcomersData = {};
  let insightsData = {};
  let epsChart;
  let latestDate = "-";

  async function loadData() {
    const ts = new Date().getTime();
    const [stockRes, epsRes, newcomersRes, insightsRes] = await Promise.all([
      fetch("data.json?t=" + ts),
      fetch("eps.json?t=" + ts),
      fetch("newcomers.json?t=" + ts),
      fetch("insights.json?t=" + ts)
    ]);

    const stockJson = await stockRes.json();
    stockData = stockJson.data || [];
    latestDate = stockJson.date || "-";
    epsData = await epsRes.json();
    newcomersData = await newcomersRes.json();
    insightsData = await insightsRes.json();

    // âœ… å¼·åˆ¶ stock_id ç‚ºå­—ä¸²
    stockData.forEach(item => {
      item.stock_id = String(item.stock_id).trim();
      const cleanName = item.name ? item.name.trim() : item.stock_id;
      stockNames[item.stock_id] = cleanName;
    });

    renderNewcomers();
    renderInsights();
  }

  function updateTable(code) {
    const title = document.getElementById("title");
    title.textContent = `å°è‚¡äº¤æ˜“è¿½è¹¤ - ${stockNames[code] || ""} (${code})`;

    const tbody = document.getElementById("dataTable").querySelector("tbody");
    tbody.innerHTML = "";

    // âœ… å¼·åˆ¶æ¯”å°å­—ä¸²
    const stock = stockData.find(x => String(x.stock_id).trim() === String(code).trim());
    if (!stock) {
      alert("æŸ¥ç„¡æ­¤è‚¡ç¥¨");
      return;
    }

    const foreign = Math.round(stock.foreign_net / 1000);
    const invest = Math.round(stock.invest_net / 1000);
    const total = foreign + invest;

    const tr = document.createElement("tr");
    const cells = [
      latestDate,
      foreign,
      invest,
      total,
      (stock.foreign_ratio * 100).toFixed(2) + "%",
      (stock.invest_ratio * 100).toFixed(2) + "%"
    ];

    cells.forEach((val, i) => {
      const td = document.createElement("td");
      td.textContent = val;
      if (i > 0 && i < 4) {
        if (parseFloat(val) > 0) td.classList.add("positive");
        else if (parseFloat(val) < 0) td.classList.add("negative");
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }

  // ðŸ” æœå°‹æ¯”å°åŒæ¨£ä¿®æ­£
  const input=document.getElementById("stockInput");
  const suggestions=document.getElementById("suggestions");

  input.addEventListener("input",()=>{
    const q=input.value.trim();
    suggestions.innerHTML="";
    if(!q){ suggestions.style.display="none"; return; }

    const matches = Object.entries(stockNames)
      .filter(([id, name]) => id.includes(q) || name.includes(q));
    if(matches.length===0){ suggestions.style.display="none"; return; }

    matches.forEach(([id, name])=>{
      const div=document.createElement("div");
      div.textContent=`${name} (${id})`;
      div.onclick=()=>{ input.value=`${name} (${id})`; updateView(id); suggestions.style.display="none"; };
      suggestions.appendChild(div);
    });
    suggestions.style.display="block";
  });
</script>
