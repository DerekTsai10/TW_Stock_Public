<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">
  <title>æ³•äººè²·è³£è¶…æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    @media (max-width: 768px) {
      .mobile-reset { transform: scale(1) !important; padding: 1rem !important; }
      .mobile-col { grid-template-columns: 1fr !important; gap: 1.5rem !important; }
      .mobile-center { text-align: center !important; }
      input, select, button { font-size: 1rem; padding: 0.6rem 0.8rem; }
      h1 { font-size: 1.8rem; }
      h3 { font-size: 1.5rem; }
    }
    #suggestions { z-index: 20; }
    #clear-input-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.15s;
    }
    #clear-input-btn:hover {
      color: #6b7280;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 1rem;
        font-size: 0.9rem;
    }
    .legend-color {
        width: 10px;
        height: 3px;
        margin-right: 5px;
        border-radius: 2px;
    }
  </style>
</head>

<body class="p-6 bg-gray-50 text-lg">
  <div class="max-w-7xl mx-auto transform scale-150 origin-top mobile-reset transition-transform duration-300">

    <h1 id="page-title" class="text-3xl font-bold mb-8 mobile-center">
      æ³•äººè²·è³£è¶…æŸ¥è©¢
    </h1>

    <div class="my-6 flex flex-col md:flex-row md:items-center md:space-x-3 relative w-full md:w-80 mx-auto md:mx-0">
      <label for="search-input" class="font-bold text-xl mb-2 md:mb-0 whitespace-nowrap mobile-center">
        è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼š
      </label>
      <div class="relative w-full md:w-80">
        <input type="text" id="search-input"
               placeholder="å°ç©é›» æˆ– 2330"
               class="w-full border p-3 rounded text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
               autocomplete="off"
               autofocus>
        <button id="clear-input-btn" class="absolute hidden focus:outline-none" title="æ¸…é™¤è¼¸å…¥">
            &times;
        </button>
        <ul id="suggestions"
            class="absolute w-full bg-white border rounded mt-1 shadow-lg hidden max-h-60 overflow-y-auto z-20 text-lg"></ul>
      </div>
    </div>

    <div id="insights-view">
      <div class="grid grid-cols-2 gap-6 mb-8 mobile-col">
        <div class="p-6 border rounded bg-white shadow">
          <h3 id="insights-title" class="font-bold text-2xl mb-6 mobile-center">ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–®</h3>

          <div class="grid grid-cols-2 gap-6 text-gray-700">
            <div>
              <h4 class="font-semibold mb-3">ğŸŒ ç•¶æ—¥å¤–æœ¬æ¯”å‰ 10</h4>
              <ul id="foreign_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
            </div>
            <div>
              <h4 class="font-semibold mb-3">ğŸ¦ ç•¶æ—¥æŠ•æœ¬æ¯”å‰ 10</h4>
              <ul id="invest_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
            </div>
          </div>

          <div id="period-section" class="mt-8"></div>
        </div>

        <div class="p-6 border rounded bg-white shadow">
          <div class="grid grid-cols-2 gap-6 mobile-col">
            <div>
              <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸš€ æ–°ä¸Šæ¦œ</h3>
              <div id="newcomers-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
            </div>
            <div>
              <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸ”¥ çˆ†é‡åµæ¸¬</h3>
              <div id="explosive-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="stock-view" class="hidden">
        <div id="kline-chart-wrapper" class="p-6 border rounded bg-white shadow mb-8">
            <h3 class="font-bold text-2xl mb-4 mobile-center">è‚¡åƒ¹ K ç·šåœ–</h3>
            <div id="klineChartContainer" class="relative" style="height: 300px;">
                <div class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</div>
            </div>
            <div id="kline-legend" class="mt-4 flex flex-wrap justify-center"></div>
        </div>

        <div id="chart-container" class="p-6 border rounded bg-white shadow mb-8">
            <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶…è¶¨å‹¢åœ– (Chart.js)</h3>
            <div class="relative h-96">
                <canvas id="tradingChart"></canvas>
            </div>
        </div>

        <div class="p-6 border rounded bg-white shadow overflow-x-auto">
            <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶… (å¼µ)</h3>
            <table id="trading-table" class="min-w-full text-center border-collapse border text-lg">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
                        <th class="border px-4 py-3 whitespace-nowrap">å¤–è³‡</th>
                        <th class="border px-4 py-3 whitespace-nowrap">æŠ•ä¿¡</th>
                        <th class="border px-4 py-3 whitespace-nowrap">è‡ªç‡Ÿå•†</th>
                        <th class="border px-4 py-3 whitespace-nowrap">åˆè¨ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="border px-4 py-8 text-gray-500">
                            è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
  </div>

  <script>
  let records = [];
  let stockList = [];
  let tradingChart;

  const klineChartContainer = document.getElementById('klineChartContainer');
  let klineChart = null;
  const klineLegend = document.getElementById('kline-legend'); // MA åœ–ä¾‹

  const input = document.getElementById("search-input");
  const suggestions = document.getElementById("suggestions");
  const tableBody = document.querySelector("#trading-table tbody");
  const pageTitle = document.getElementById("page-title");
  const clearBtn = document.getElementById("clear-input-btn");

  const insightsView = document.getElementById('insights-view');
  const stockView = document.getElementById('stock-view');

  function toggleView(view) {
    if (view === 'insights') {
      insightsView.classList.remove('hidden');
      stockView.classList.add('hidden');
      pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
    } else if (view === 'stock') {
      insightsView.classList.add('hidden');
      stockView.classList.remove('hidden');
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleView('insights');
  });

  // --- è¼‰å…¥ data.json å»ºè‚¡ç¥¨æ¸…å–® (çœç•¥) ---
  fetch("data.json")
    .then(res => res.json())
    .then(data => {
      records = data.records;
      records.forEach(day => {
        day.stocks.forEach(s => {
          if (!stockList.find(x => x.id === s.stock_id)) {
            stockList.push({ id: s.stock_id, name: s.name.trim() });
          }
        });
      });
    });

  function createStockLink(stock_id, name) {
    const a = document.createElement("a");
    a.href = `https://www.cmoney.tw/finance/f00025.aspx?s=${stock_id}`;
    a.target = "_blank";
    a.textContent = `${name} (${stock_id})`;
    a.className = "hover:underline text-black";
    return a;
  }

  // --- insights.json, newcomers.json, explosive.json (çœç•¥) ---
  // ... (ä¿æŒä¸è®Š)

  // --- æœå°‹ (çœç•¥) ---
  // ... (ä¿æŒä¸è®Š)

  function showStockData(keyword) {
    tableBody.innerHTML = "";
    const colorize = (val) => {
      const num = Number(val);
      const formattedVal = num.toLocaleString();
      if (num > 0) return `<span class="text-red-600">${formattedVal}</span>`;
      if (num < 0) return `<span class="text-green-600">${formattedVal}</span>`;
      return formattedVal;
    };

    const kw = keyword.toString().replace(/\s|ã€€/g, "").trim();
    let foundStock = null;
    let dataFound = false;

    const chartLabels = [];
    const chartForeignData = [];
    const chartInvestData = [];
    const chartDealerData = [];
    const chartTotalData = [];

    for (let i = records.length - 1; i >= 0; i--) {
      const day = records[i];
      const stock = day.stocks.find(s =>
        s.stock_id.toString().replace(/\s|ã€€/g, "").trim() === kw ||
        s.name.replace(/\s|ã€€/g, "").includes(kw)
      );
      if (stock) {
        dataFound = true;
        if (!foundStock) foundStock = stock;

        const foreign = Math.round(stock.foreign_net/1000);
        const invest  = Math.round(stock.invest_net/1000);
        const dealer  = Math.round(stock.dealer_net/1000);
        const total   = Math.round((stock.foreign_net + stock.invest_net + stock.dealer_net)/1000);

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
          <td class="border px-4 py-2">${day.date}</td>
          <td class="border px-4 py-2">${colorize(foreign)}</td>
          <td class="border px-4 py-2">${colorize(invest)}</td>
          <td class="border px-4 py-2">${colorize(dealer)}</td>
          <td class="border px-4 py-2">${colorize(total)}</td>`;
        tableBody.prepend(tr);

        chartLabels.push(day.date);
        chartForeignData.push(foreign);
        chartInvestData.push(invest);
        chartDealerData.push(dealer);
        chartTotalData.push(total);
      }
    }

    if (foundStock && dataFound) {
      toggleView('stock');
      pageTitle.textContent = `æ³•äººè²·è³£è¶…æŸ¥è©¢ - ${foundStock.name} (${foundStock.stock_id})`;
      loadKlineData(foundStock.stock_id.toString());
      updateChart(chartLabels, chartForeignData, chartInvestData, chartDealerData, chartTotalData);
    } else {
      toggleView('insights');
      pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
      console.log(`[ğŸ” LOG - Search] æŸ¥è©¢å¤±æ•—æˆ–ç„¡æ³•äººè²·è³£è¶…è³‡æ–™: ${keyword}`);
    }
  }

  function updateChart(labels, foreignData, investData, dealerData, totalData) {
    const ctx = document.getElementById('tradingChart').getContext('2d');

    if (tradingChart) {
      tradingChart.destroy();
    }

    tradingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'å¤–è³‡',
            data: foreignData,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            tension: 0.3,
            fill: false,
          },
          {
            label: 'æŠ•ä¿¡',
            data: investData,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            tension: 0.3,
            fill: false,
          },
          {
            label: 'è‡ªç‡Ÿå•†',
            data: dealerData,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            tension: 0.3,
            fill: false,
          },
          {
            label: 'åˆè¨ˆ',
            data: totalData,
            borderColor: 'rgb(153, 102, 255)',
            backgroundColor: 'rgba(153, 102, 255, 0.5)',
            tension: 0.3,
            fill: false,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: { title: { display: true, text: 'æ—¥æœŸ' } },
          y: { title: { display: true, text: 'è²·è³£è¶…å¼µæ•¸' } }
        }
      }
    });
  }

  const ensureFiniteNumber = (value) => {
      const num = Number(value);
      return (Number.isFinite(num) && num !== null) ? num : 0;
  };
  
  /**
   * è¨ˆç®—ç°¡å–®ç§»å‹•å¹³å‡ç·š (Simple Moving Average, SMA)
   * @param {Array<Object>} data - åŒ…å« { time, close } çš„ K ç·šè³‡æ–™
   * @param {number} period - å‡ç·šæœŸé–“ (e.g., 5, 10, 20)
   * @returns {Array<Object>} åŒ…å« { time, value } çš„å‡ç·šè³‡æ–™
   */
  function calculateSMA(data, period) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
          if (i < period - 1) {
              // è³‡æ–™é»ä¸è¶³è¨ˆç®—é€±æœŸæ™‚ï¼ŒMA è¨­ç‚º null
              result.push({ time: data[i].time, value: null });
              continue;
          }
  
          let sum = 0;
          // å‘å‰è¨ˆç®— period å€‹æ”¶ç›¤åƒ¹çš„ç¸½å’Œ
          for (let j = 0; j < period; j++) {
              sum += data[i - j].close;
          }
  
          result.push({
              time: data[i].time,
              value: sum / period
          });
      }
      return result;
  }

  /**
   * åœ¨åœ–è¡¨ä¸‹æ–¹ç¹ªè£½ MA ç·šçš„å®¢è£½åŒ–åœ–ä¾‹
   * @param {Array<Object>} periods - åŒ…å« { period, color, title } çš„ MA è³‡è¨Š
   */
  function drawLegend(periods) {
      klineLegend.innerHTML = '';
      periods.forEach(ma => {
          const item = document.createElement('div');
          item.className = 'legend-item';
          
          const colorBox = document.createElement('span');
          colorBox.className = 'legend-color';
          colorBox.style.backgroundColor = ma.color;

          const titleText = document.createTextNode(ma.title);

          item.appendChild(colorBox);
          item.appendChild(titleText);
          klineLegend.appendChild(item);
      });
  }


  // --- K ç·šåœ–åŠŸèƒ½ ---
  function loadKlineData(stockId) {
      if (!klineChartContainer) return;

      klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</div>`;
      klineLegend.innerHTML = ''; // æ¸…ç©ºåœ–ä¾‹

      if (klineChart) {
          try { klineChart.remove(); } catch (e) {}
          klineChart = null;
      }

      if (typeof LightweightCharts === 'undefined' || typeof LightweightCharts.createChart !== 'function') {
          console.error("[âŒ LOG - Kline] LightweightCharts æœªè¼‰å…¥æˆ–ä¸æ”¯æ´ createChart");
          klineChartContainer.innerHTML = `<div class="text-center py-4 text-red-500">K ç·šç¨‹å¼åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚</div>`;
          return;
      }

      fetch("Kline.json")
          .then(res => {
              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
              return res.json();
          })
          .then(klineData => {
              let filteredData = [];

              if (!Array.isArray(klineData) && klineData[stockId]) {
                  filteredData = klineData[stockId];
              } else if (Array.isArray(klineData)) {
                  filteredData = klineData.filter(item =>
                      String(item.stock_id).replace(/\s|ã€€/g, "") === String(stockId)
                  );
              } else if (Array.isArray(klineData.stocks)) {
                  filteredData = klineData.stocks.filter(item =>
                      String(item.stock_id).replace(/\s|ã€€/g, "") === String(stockId)
                  );
              }

              if (!filteredData || filteredData.length === 0) {
                  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾ä¸åˆ° ${stockId} çš„ K ç·šè³‡æ–™ã€‚</div>`;
                  return;
              }

              const chartData = [];

              filteredData.forEach((item, index) => {
                  const validOpen   = ensureFiniteNumber(item.open);
                  const validHigh   = ensureFiniteNumber(item.high);
                  const validLow    = ensureFiniteNumber(item.low);
                  const validClose  = ensureFiniteNumber(item.close);
                  const validVolume = ensureFiniteNumber(item.volume);

                  if (validOpen === 0 || validHigh === 0 || validLow === 0 || validClose === 0) return;

                  const dateStr = (item.date || item.Date || item.trade_date || "").toString();
                  if (!dateStr) return;

                  chartData.push({
                      // LightWeightCharts çš„æ™‚é–“è»¸éœ€è¦æ˜¯ "YYYY-MM-DD" æ ¼å¼çš„å­—ä¸²ï¼Œæˆ–ç§’ç´š Unix Timeã€‚
                      // é€™è£¡ç¢ºä¿å‚³å…¥ "YYYY-MM-DD" å­—ä¸²ï¼Œä¸¦è®“ LightWeightCharts å…§éƒ¨è§£æã€‚
                      time: dateStr,
                      open: validOpen,
                      high: validHigh,
                      low: validLow,
                      close: validClose,
                      value: validVolume
                  });
              });

              if (chartData.length === 0) {
                  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾åˆ°åŸå§‹è³‡æ–™ï¼Œä½†ç„¡æ³•ç¹ªè£½æœ‰æ•ˆ K ç·šã€‚</div>`;
                  return;
              }

              klineChartContainer.innerHTML = "";
              const width = klineChartContainer.clientWidth || 600;

              klineChart = LightweightCharts.createChart(klineChartContainer, {
                  width: width,
                  height: 300,
                  layout: { backgroundColor: '#ffffff', textColor: '#333' },
                  grid: {
                      vertLines: { color: '#e0e0e0' },
                      horzLines: { color: '#e0e0e0' }
                  },
                  timeScale: {
                      timeVisible: true,
                      secondsVisible: false,
                      // â¬‡ï¸ ä¿®æ­£ X è»¸æ ¼å¼: åªä¿ç•™æœˆä»½æ•¸å­—
                      tickMarkFormatter: (time, tickMarkType, locale) => {
                          // time åƒæ•¸æ˜¯ç§’ç´šæ™‚é–“æˆ³ (Number)ï¼Œå¿…é ˆä¹˜ 1000 è½‰ç‚ºæ¯«ç§’ç´šã€‚
                          const date = new Date(time * 1000); 
                          const day = date.getDate();
                          const month = date.getMonth() + 1; // 0-11 æœˆ

                          if (tickMarkType === LightweightCharts.TickMarkType.Month) {
                              // åªé¡¯ç¤ºæœˆä»½æ•¸å­— (ä¾‹å¦‚: 6, 7)ï¼Œç§»é™¤ã€Œæœˆã€å­—
                              return `${month}`;
                          }
                          if (tickMarkType === LightweightCharts.TickMarkType.Year) {
                              // é¡¯ç¤ºå¹´ä»½
                              return date.getFullYear().toString();
                          }
                          // é è¨­æƒ…æ³ (é€±/æ—¥)ï¼Œåªé¡¯ç¤ºæœˆä»½æ•¸å­—ï¼Œä»¥ç¢ºä¿åªé¡¯ç¤ºã€Œæœˆã€å±¤ç´šï¼Œä¸¦éš±è—ã€Œæ—¥ã€ã€‚
                          // LightWeightCharts æœƒæ ¹æ“šé–“è·è‡ªå‹•é¸æ“‡é¡¯ç¤º Year/Month/Dayã€‚
                          // é€™è£¡åƒ…åœ¨ LightWeightCharts åˆ¤å®šç‚º Month ç´šåˆ¥æ™‚ï¼Œé¡¯ç¤ºæœˆä»½ã€‚
                          // ç‚ºäº†æ»¿è¶³ã€Œåªä¿ç•™æœˆã€çš„è¦æ±‚ï¼Œæˆ‘å€‘åœ¨é Year/Month ç´šåˆ¥æ™‚ï¼Œå˜—è©¦è®“å®ƒä¿æŒç²¾ç°¡ã€‚
                          // ç¶“é©—ä¸Šï¼ŒLightWeightCharts æœƒå°‡å¤šé¤˜çš„ TickMark æ“ å£“æ‰ï¼Œæ‰€ä»¥åªè¿”å›æœˆä»½æ˜¯æœ€ä¹¾æ·¨çš„ã€‚
                          return `${month}`; 
                      },
                  },
                  paneContainer: klineChartContainer
              });

              // K ç·š series
              const candleSeries = klineChart.addCandlestickSeries({
                  upColor: '#ef5350',
                  downColor: '#26a69a',
                  borderVisible: false,
                  wickUpColor: '#ef5350',
                  wickDownColor: '#26a69a',
                  title: 'Kç·š',             // æ¢å¾© K ç·šæ¨™ç±¤
                  lastValueVisible: true,   // ç¢ºä¿æœ€å¾Œåƒ¹æ ¼å¯è¦‹
                  priceLineVisible: true,
              });
              candleSeries.setData(chartData);

              // ----- æ–°å¢ï¼šè¨ˆç®—ä¸¦ç¹ªè£½ç§»å‹•å¹³å‡ç·š (MA) -----
              const periods = [
                  { period: 5, color: 'rgb(255, 165, 0)', title: '5MA' },    // æ©™è‰²
                  { period: 10, color: 'rgb(50, 205, 50)', title: '10MA' },  // ç¶ è‰²
                  { period: 20, color: 'rgb(255, 0, 255)', title: '20MA' },  // æ´‹ç´…è‰²/ç´«ç´…è‰²
                  { period: 60, color: 'rgb(65, 105, 225)', title: '60MA' } // çš‡å®¶è—
              ];

              periods.forEach(ma => {
                  const maData = calculateSMA(chartData, ma.period);
                  
                  const maSeries = klineChart.addLineSeries({
                      color: ma.color,
                      lineWidth: 1, 
                      // â¬‡ï¸ ä¿®æ­£ï¼šéš±è—åœ–è¡¨ä¸Šçš„ MA åƒ¹æ ¼æ¨™ç±¤å’Œæ•¸å€¼ï¼Œä½¿ç”¨ç©ºå­—ä¸²
                      title: '', 
                      lastValueVisible: false, 
                      priceLineVisible: false, 
                  });

                  maSeries.setData(maData.filter(d => d.value !== null));
              });
              
              // ç¹ªè£½ MA å®¢è£½åŒ–åœ–ä¾‹ (æ”¾åœ¨åœ–è¡¨ä¸‹æ–¹)
              drawLegend(periods);
              // ------------------------------------------------

              // â–¶ èª¿æ•´è‚¡åƒ¹çš„ price scaleï¼Œåªä½”ä¸Šæ–¹ 70%
              klineChart.priceScale('right').applyOptions({
                  scaleMargins: {
                      top: 0.05,   // ä¸Šæ–¹ç•™ä¸€é»ç©ºé–“
                      bottom: 0.25 // åº•éƒ¨ç©ºå‡º 25% çµ¦æˆäº¤é‡
                  }
              });

              // æˆäº¤é‡ seriesï¼Œç”¨ç¨ç«‹çš„ 'volume' scaleï¼Œä½”ä¸‹æ–¹ 25%
              const volumeSeries = klineChart.addHistogramSeries({
                  priceScaleId: 'volume',
                  priceFormat: { type: 'volume' },
                  title: 'æˆäº¤é‡',           // æ¢å¾©æˆäº¤é‡æ¨™ç±¤
                  lastValueVisible: true,
                  priceLineVisible: true,
              });

              klineChart.priceScale('volume').applyOptions({
                  scaleMargins: {
                      top: 0.8,  // å¾ 80% é–‹å§‹
                      bottom: 0  // åˆ°æœ€åº•
                  }
              });

              const volumeData = chartData.map(d => ({
                  time: d.time,
                  value: ensureFiniteNumber(d.value),
                  color: d.close >= d.open ? '#ef535099' : '#26a69a99',
              }));
              volumeSeries.setData(volumeData);

              // ä¸€è¼‰å…¥å°±çœ‹åˆ°å…¨éƒ¨ 180 å¤©
              klineChart.timeScale().fitContent();
          })
          .catch(error => {
              console.error("[âŒ LOG - Kline] K ç·šåœ–è¼‰å…¥éŒ¯èª¤:", error.message || error);
              klineChartContainer.innerHTML = `<div class="text-center py-4 text-red-500">K ç·šåœ–è¼‰å…¥éŒ¯èª¤ï¼Œè«‹æ‰“é–‹ console æŸ¥çœ‹è©³æƒ…ã€‚</div>`;
          });
  }

  window.addEventListener('resize', () => {
      if (klineChart && klineChartContainer) {
          const width = klineChartContainer.clientWidth || 600;
          klineChart.applyOptions({ width });
      }
  });

  </script>
</body>
</html>
