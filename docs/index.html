<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">
  <title>æ³•äººè²·è³£è¶…æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @media (max-width: 768px) {
      .mobile-reset {transform: scale(1)!important;padding:1rem!important;}
      .mobile-col {grid-template-columns:1fr!important;gap:1.5rem!important;}
      .mobile-center {text-align:center!important;}
      input,select,button {font-size:1rem;padding:0.6rem 0.8rem;}
      h1{font-size:1.8rem;} h3{font-size:1.5rem;}
    }
  </style>
</head>

<body class="p-6 bg-gray-50 text-lg">
  <div class="max-w-7xl mx-auto transform scale-150 origin-top mobile-reset transition-transform duration-300">

    <h1 id="page-title" class="text-3xl font-bold mb-8 mobile-center">
      æ³•äººè²·è³£è¶…æŸ¥è©¢
    </h1>

    <!-- æœå°‹æ¡† + Kç·šæŒ‰éˆ• -->
    <div class="my-6 flex flex-col md:flex-row md:items-center md:space-x-3 relative w-full md:w-auto mx-auto md:mx-0">
      <label class="font-bold text-xl mb-2 md:mb-0 whitespace-nowrap mobile-center">
        è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼š
      </label>
      <div class="relative flex items-center space-x-2 w-full md:w-auto">
        <div class="relative w-full md:w-80">
          <input type="text" id="search-input"
                 placeholder="å°ç©é›» æˆ– 2330"
                 class="w-full border p-3 rounded text-lg"
                 autocomplete="off">
          <ul id="suggestions"
              class="absolute w-full bg-white border rounded mt-1 shadow-lg hidden max-h-60 overflow-y-auto z-10 text-lg"></ul>
        </div>
        <button id="kline-btn"
                class="bg-blue-600 text-white px-4 py-3 rounded hover:bg-blue-700 transition">
          ğŸ“ˆ Kç·š
        </button>
      </div>
    </div>

    <!-- æŒ‡æ¨™å€ -->
    <div class="grid grid-cols-2 gap-6 mb-8 mobile-col">
      <div class="p-6 border rounded bg-white shadow">
        <h3 id="insights-title" class="font-bold text-2xl mb-6 mobile-center">ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–®</h3>
        <div class="grid grid-cols-2 gap-6 text-gray-700">
          <div>
            <h4 class="font-semibold mb-3">ğŸŒ å¤–è³‡è²·è¶…æŠ•æœ¬æ¯”å‰ 10</h4>
            <ul id="foreign_ratio_list" class="list-disc pl-6 space-y-2 text-lg"></ul>
          </div>
          <div>
            <h4 class="font-semibold mb-3">ğŸ¦ æŠ•ä¿¡è²·è¶…æŠ•æœ¬æ¯”å‰ 10</h4>
            <ul id="invest_ratio_list" class="list-disc pl-6 space-y-2 text-lg"></ul>
          </div>
        </div>
        <div id="industry-section" class="mt-8"></div>
      </div>

      <div class="p-6 border rounded bg-white shadow">
        <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸš€ æ–°ä¸Šæ¦œ</h3>
        <div id="newcomers-container" class="text-gray-700 text-lg mb-6">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>

        <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸ”¥ æˆäº¤é‡æš´å¢</h3>
        <div id="volume-container" class="text-gray-700 text-lg">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
      </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="p-6 border rounded bg-white shadow overflow-x-auto">
      <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶… (å¼µ)</h3>
      <table id="trading-table" class="table-auto w-full text-center border-collapse border text-lg">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-6 py-3">æ—¥æœŸ</th>
            <th class="border px-6 py-3">å¤–è³‡</th>
            <th class="border px-6 py-3">æŠ•ä¿¡</th>
            <th class="border px-6 py-3">è‡ªç‡Ÿå•†</th>
            <th class="border px-6 py-3">åˆè¨ˆ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  let records = [], stockList = [];
  const input = document.getElementById("search-input"),
        suggestions = document.getElementById("suggestions"),
        tableBody = document.querySelector("#trading-table tbody"),
        pageTitle = document.getElementById("page-title");

  // è¼‰å…¥ data.json
  fetch("data.json").then(r=>r.json()).then(d=>{
    records=d.records;
    records.forEach(day=>{
      day.stocks.forEach(s=>{
        if(!stockList.find(x=>x.id===s.stock_id))
          stockList.push({id:s.stock_id,name:s.name.trim()});
      });
    });
  });

  // insights.json
  fetch("insights.json").then(r=>r.json()).then(d=>{
    if(d.date)
      document.getElementById("insights-title").textContent=`ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–® (è³‡æ–™æ—¥æœŸï¼š${d.date})`;
    const f=document.getElementById("foreign_ratio_list"),
          i=document.getElementById("invest_ratio_list");
    f.innerHTML=""; i.innerHTML="";
    d.foreign_ratio_ranking?.slice(0,10).forEach(it=>{
      const li=document.createElement("li");
      li.textContent=`${it.name} (${it.stock_id}) - ${it.foreign_ratio.toFixed(2)}%`;
      f.appendChild(li);
    });
    d.invest_ratio_ranking?.slice(0,10).forEach(it=>{
      const li=document.createElement("li");
      li.textContent=`${it.name} (${it.stock_id}) - ${it.invest_ratio.toFixed(2)}%`;
      i.appendChild(li);
    });
  });

  // newcomers.json
  fetch("newcomers.json").then(r=>r.json()).then(d=>{
    const nc=d.newcomers||{}, c=document.getElementById("newcomers-container"),
          v=document.getElementById("volume-container");
    c.innerHTML=""; v.innerHTML="";
    if(nc.foreign?.length){
      const p=document.createElement("p");
      p.className="font-semibold mt-2"; p.textContent="ğŸŒ å¤–è³‡æ–°ä¸Šæ¦œï¼š";
      c.appendChild(p);
      const ul=document.createElement("ul"); ul.className="list-disc pl-6 space-y-1";
      nc.foreign.forEach(s=>{const li=document.createElement("li");li.textContent=`${s.name} (${s.stock_id})`;ul.appendChild(li);});
      c.appendChild(ul);
    }
    if(nc.invest?.length){
      const p=document.createElement("p");
      p.className="font-semibold mt-2"; p.textContent="ğŸ¦ æŠ•ä¿¡æ–°ä¸Šæ¦œï¼š";
      c.appendChild(p);
      const ul=document.createElement("ul"); ul.className="list-disc pl-6 space-y-1";
      nc.invest.forEach(s=>{const li=document.createElement("li");li.textContent=`${s.name} (${s.stock_id})`;ul.appendChild(li);});
      c.appendChild(ul);
    }
    if(!nc.foreign?.length&&!nc.invest?.length) c.textContent="ï¼ˆä»Šæ—¥ç„¡æ–°ä¸Šæ¦œè‚¡ç¥¨ï¼‰";
    if(d.volume_spike?.length){
      const ul=document.createElement("ul"); ul.className="list-disc pl-6 space-y-1";
      d.volume_spike.forEach(s=>{const li=document.createElement("li");li.textContent=`${s.name} (${s.stock_id})`;ul.appendChild(li);});
      v.appendChild(ul);
    }else v.textContent="ï¼ˆä»Šæ—¥ç„¡æˆäº¤é‡æš´å¢è‚¡ç¥¨ï¼‰";
  }).catch(()=>{document.getElementById("newcomers-container").textContent="ç„¡æ³•è¼‰å…¥è³‡æ–™";
                document.getElementById("volume-container").textContent="ç„¡æ³•è¼‰å…¥è³‡æ–™";});

  // å³æ™‚æœå°‹ + Enter æŸ¥è©¢
  input.addEventListener("input",()=>{
    const kw=input.value.trim(); suggestions.innerHTML="";
    if(!kw){suggestions.classList.add("hidden");return;}
    const m=stockList.filter(s=>s.id.includes(kw)||s.name.includes(kw)).slice(0,10);
    if(!m.length){suggestions.classList.add("hidden");return;}
    m.forEach(s=>{
      const li=document.createElement("li");
      li.textContent=`${s.name} (${s.id})`;
      li.className="p-2 hover:bg-gray-200 cursor-pointer";
      li.addEventListener("click",()=>{input.value=s.id;suggestions.classList.add("hidden");showStockData(s.id);});
      suggestions.appendChild(li);
    });
    suggestions.classList.remove("hidden");
  });
  input.addEventListener("keyup",e=>{
    if(e.key==="Enter"){
      const kw=input.value.trim();
      if(kw){showStockData(kw);suggestions.classList.add("hidden");}
    }
  });

  function showStockData(k){
    tableBody.innerHTML="";
    const color=v=>v>0?`<span class='text-red-600'>${v}</span>`:v<0?`<span class='text-green-600'>${v}</span>`:v;
    let found=null;
    records.forEach(day=>{
      const s=day.stocks.find(x=>x.stock_id===k||x.name.includes(k));
      if(s){
        if(!found)found=s;
        const f=(s.foreign_net/1000).toFixed(0),
              i=(s.invest_net/1000).toFixed(0),
              d=(s.dealer_net/1000).toFixed(0),
              t=((s.foreign_net+s.invest_net+s.dealer_net)/1000).toFixed(0);
        const tr=document.createElement("tr");
        tr.innerHTML=`<td class='border px-4 py-2'>${day.date}</td>
          <td class='border px-4 py-2'>${color(f)}</td>
          <td class='border px-4 py-2'>${color(i)}</td>
          <td class='border px-4 py-2'>${color(d)}</td>
          <td class='border px-4 py-2'>${color(t)}</td>`;
        tableBody.appendChild(tr);
      }
    });
    if(found) pageTitle.textContent=`æ³•äººè²·è³£è¶…æŸ¥è©¢ - ${found.name} (${found.stock_id})`;
    else{
      pageTitle.textContent="æ³•äººè²·è³£è¶…æŸ¥è©¢";
      const tr=document.createElement("tr");
      tr.innerHTML="<td colspan='5' class='border px-4 py-2 text-red-500'>æ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™</td>";
      tableBody.appendChild(tr);
    }
  }

  // ğŸ“ˆ Kç·šæŒ‰éˆ•
  document.getElementById("kline-btn").addEventListener("click",()=>{
    const val=input.value.trim();
    if(!val){alert("è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±");return;}
    let id=/^\d+$/.test(val)?val:null;
    if(!id){
      const f=stockList.find(s=>s.name.includes(val));
      if(f) id=f.id;
    }
    if(!id){alert("æ‰¾ä¸åˆ°å°æ‡‰çš„è‚¡ç¥¨ä»£ç¢¼");return;}
    const url=`https://tw.stock.yahoo.com/quote/${id}.TW/chart`;
    window.open(url,"_blank");
  });
  </script>
</body>
</html>
