<!DOCTYPE html>
<html lang="zh-tw">
<head>
Â  <meta charset="utf-8">
Â  <title>æ³•äººè²·è³£è¶…æŸ¥è©¢</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
Â  <style>
Â  Â  /* âœ… æ¡Œæ©Ÿç¶­æŒ scale-150 + ç½®ä¸­ï¼ˆç©©å®šç‰ˆï¼šèˆ‡å¯¬åº¦ç„¡é—œï¼‰ */
Â  Â  .desktop-zoom {
Â  Â  Â  position: relative;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%) scale(1.5);
Â  Â  Â  /* æ ¸å¿ƒä¿®æ­£ï¼šå°‡ç¸®æ”¾åŸé»å¾ top left æ”¹ç‚º top centerï¼Œç¢ºä¿ç¸®æ”¾å¾Œç½®ä¸­ */
Â  Â  Â  transform-origin: top center; 
Â  Â  }

Â  Â  /* âœ… åªè®“ lightweight-charts çš„å¤–æ¡†ã€Œè¦–è¦ºä¸Šä¸åƒ scaleã€ */
Â  Â  .no-scale-chart {
Â  Â  Â  width: 150%;
Â  Â  Â  transform: scale(0.6666667);
Â  Â  Â  transform-origin: top left;
Â  Â  }

Â  Â  @media (max-width: 768px) {
Â  Â  Â  .mobile-reset { transform: scale(1) !important; padding: 1rem !important; }
Â  Â  Â  .mobile-col { grid-template-columns: 1fr !important; gap: 1.5rem !important; }
Â  Â  Â  .mobile-center { text-align: center !important; }
Â  Â  Â  input, select, button { font-size: 1rem; padding: 0.6rem 0.8rem; }
Â  Â  Â  h1 { font-size: 1.8rem; }
Â  Â  Â  h3 { font-size: 1.5rem; }

Â  Â  Â  /* âœ… æ‰‹æ©Ÿä¸è¦ç¸®æ”¾ï¼Œä¹Ÿä¸è¦åç¸®æ”¾ + å–æ¶ˆ left/translate */
Â  Â  Â  .desktop-zoom {Â 
Â  Â  Â  Â  position: static !important;
Â  Â  Â  Â  left: 0 !important;
Â  Â  Â  Â  transform: none !important;Â 
Â  Â  Â  }
Â  Â  Â  .no-scale-chart { width: 100% !important; transform: none !important; }
Â  Â  }

Â  Â  #suggestions { z-index: 20; }
Â  Â  #clear-input-btn {
Â  Â  Â  position: absolute;
Â  Â  Â  right: 10px;
Â  Â  Â  top: 50%;
Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: #9ca3af;
Â  Â  Â  transition: color 0.15s;
Â  Â  }
Â  Â  #clear-input-btn:hover {
Â  Â  Â  color: #6b7280;
Â  Â  }

Â  Â  #kline-legend {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  padding: 5px 10px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  line-height: 1.4;
Â  Â  }
Â  Â  .legend-item { display: flex; align-items: center; }
Â  Â  .legend-color {
Â  Â  Â  Â  width: 10px; height: 3px; margin-right: 5px; border-radius: 2px;
Â  Â  }
Â  </style>
</head>

<body class="p-6 bg-gray-50 text-lg">
Â  <div class="max-w-7xl mx-auto desktop-zoom origin-top mobile-reset transition-transform duration-300">

Â  Â  <h1 id="page-title" class="text-3xl font-bold mb-8 mobile-center">
Â  Â  Â  æ³•äººè²·è³£è¶…æŸ¥è©¢
Â  Â  </h1>

Â  Â  <div class="my-6 flex flex-col md:flex-row md:items-center md:space-x-3 relative w-full md:w-80 mx-auto md:mx-0">
Â  Â  Â  <label for="search-input" class="font-bold text-xl mb-2 md:mb-0 whitespace-nowrap mobile-center">
Â  Â  Â  Â  è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼š
Â  Â  Â  </label>
Â  Â  Â  <div class="relative w-full md:w-80">
Â  Â  Â  Â  <input type="text" id="search-input"
Â  Â  Â  Â  Â  Â  Â  Â placeholder="å°ç©é›» æˆ– 2330"
Â  Â  Â  Â  Â  Â  Â  Â class="w-full border p-3 rounded text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
Â  Â  Â  Â  Â  Â  Â  Â autocomplete="off"
Â  Â  Â  Â  Â  Â  Â  Â autofocus>
Â  Â  Â  Â  <button id="clear-input-btn" class="absolute hidden focus:outline-none" title="æ¸…é™¤è¼¸å…¥">
Â  Â  Â  Â  Â  Â  &times;
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <ul id="suggestions"
Â  Â  Â  Â  Â  Â  class="absolute w-full bg-white border rounded mt-1 shadow-lg hidden max-h-60 overflow-y-auto z-20 text-lg"></ul>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="insights-view">
Â  Â  Â  <div class="grid grid-cols-2 gap-6 mb-8 mobile-col">
Â  Â  Â  Â  <div class="p-6 border rounded bg-white shadow">
Â  Â  Â  Â  Â  <h3 id="insights-title" class="font-bold text-2xl mb-6 mobile-center">ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–®</h3>

Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-6 text-gray-700">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h4 class="font-semibold mb-3">ğŸŒ ç•¶æ—¥å¤–æœ¬æ¯”å‰ 10</h4>
Â  Â  Â  Â  Â  Â  Â  <ul id="foreign_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h4 class="font-semibold mb-3">ğŸ¦ ç•¶æ—¥æŠ•æœ¬æ¯”å‰ 10</h4>
Â  Â  Â  Â  Â  Â  Â  <ul id="invest_ratio_list" class="list-disc pl-6 space-y-2 text-base"></ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div id="period-section" class="mt-8"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="p-6 border rounded bg-white shadow">
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-6 mobile-col">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸš€ æ–°ä¸Šæ¦œ</h3>
Â  Â  Â  Â  Â  Â  Â  <div id="newcomers-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-2xl mb-4 mobile-center">ğŸ”¥ çˆ†é‡åµæ¸¬</h3>
Â  Â  Â  Â  Â  Â  Â  <div id="explosive-container" class="text-gray-700 text-base">ï¼ˆæ­¤å€å¡Šæš«ä¸é¡¯ç¤ºå…§å®¹ï¼‰</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="stock-view" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="kline-chart-wrapper" class="p-6 border rounded bg-white shadow mb-8 no-scale-chart">
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-2xl mb-4 mobile-center">è‚¡åƒ¹ K ç·šåœ–</h3>
Â  Â  Â  Â  Â  Â  <div id="klineChartContainer" class="relative" style="height: 300px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â Â  Â  Â  Â  Â  Â  Â  Â  <div id="kline-legend" class="hidden"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â Â  Â  Â  Â  Â  Â  <div id="kline-static-legend" class="mt-4 flex flex-wrap justify-center text-sm"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="chart-container" class="p-6 border rounded bg-white shadow mb-8">
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶…è¶¨å‹¢åœ– (Chart.js)</h3>
Â  Â  Â  Â  Â  Â  <div class="relative h-96">
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="tradingChart"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="p-6 border rounded bg-white shadow overflow-x-auto">
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-2xl mb-4 mobile-center">æ³•äººè²·è³£è¶… (å¼µ)</h3>
Â  Â  Â  Â  Â  Â  <table id="trading-table" class="min-w-full text-center border-collapse border text-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="border px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="border px-4 py-3 whitespace-nowrap">å¤–è³‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="border px-4 py-3 whitespace-nowrap">æŠ•ä¿¡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="border px-4 py-3 whitespace-nowrap">è‡ªç‡Ÿå•†</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="border px-4 py-3 whitespace-nowrap">åˆè¨ˆ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="5" class="border px-4 py-8 text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  let records = [];
Â  let stockList = [];
Â  let tradingChart;

Â  const klineChartContainer = document.getElementById('klineChartContainer');
Â  let klineChart = null;
Â  let klineLegend = document.getElementById('kline-legend');
Â  const klineStaticLegend = document.getElementById('kline-static-legend');

Â  const input = document.getElementById("search-input");
Â  const suggestions = document.getElementById("suggestions");
Â  const tableBody = document.querySelector("#trading-table tbody");
Â  const pageTitle = document.getElementById("page-title");
Â  const clearBtn = document.getElementById("clear-input-btn");

Â  const insightsView = document.getElementById('insights-view');
Â  const stockView = document.getElementById('stock-view');

Â  const MA_PERIODS = [
Â  Â  Â  { period: 5, color: 'rgb(255, 165, 0)', title: '5MA', series: null },
Â  Â  Â  { period: 10, color: 'rgb(50, 205, 50)', title: '10MA', series: null },
Â  Â  Â  { period: 20, color: 'rgb(255, 0, 255)', title: '20MA', series: null },
Â  Â  Â  { period: 60, color: 'rgb(65, 105, 225)', title: '60MA', series: null }
Â  ];
Â  let candleSeries = null;
Â  let volumeSeries = null;

Â  function toggleView(view) {
Â  Â  if (view === 'insights') {
Â  Â  Â  insightsView.classList.remove('hidden');
Â  Â  Â  stockView.classList.add('hidden');
Â  Â  Â  pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
Â  Â  } else if (view === 'stock') {
Â  Â  Â  insightsView.classList.add('hidden');
Â  Â  Â  stockView.classList.remove('hidden');
Â  Â  }
Â  }

Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  toggleView('insights');
Â  });

Â  fetch("data.json")
Â  Â  .then(res => res.json())
Â  Â  .then(data => {
Â  Â  Â  records = data.records;
Â  Â  Â  records.forEach(day => {
Â  Â  Â  Â  day.stocks.forEach(s => {
Â  Â  Â  Â  Â  if (!stockList.find(x => x.id === s.stock_id)) {
Â  Â  Â  Â  Â  Â  stockList.push({ id: s.stock_id, name: s.name.trim() });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });

Â  function createStockLink(stock_id, name) {
Â  Â  const a = document.createElement("a");
Â  Â  a.href = `https://www.cmoney.tw/finance/f00025.aspx?s=${stock_id}`;
Â  Â  a.target = "_blank";
Â  Â  a.textContent = `${name} (${stock_id})`;
Â  Â  a.className = "hover:underline text-black";
Â  Â  return a;
Â  }

Â  fetch("insights.json")
Â  Â  .then(res => res.json())
Â  Â  .then(data => {
Â  Â  Â  if (data.date) {
Â  Â  Â  Â  document.getElementById("insights-title").textContent =
Â  Â  Â  Â  Â  `ğŸ“Š æŒ‡æ¨™è§€å¯Ÿæ¸…å–® (è³‡æ–™æ—¥æœŸï¼š${data.date})`;
Â  Â  Â  }

Â  Â  Â  const dailyForeign = (data.foreign_ratio_ranking || []).slice(0, 10);
Â  Â  Â  const dailyInvest Â = (data.invest_ratio_ranking Â || []).slice(0, 10);

Â  Â  Â  const foreignList = document.getElementById("foreign_ratio_list");
Â  Â  Â  const investList Â = document.getElementById("invest_ratio_list");
Â  Â  Â  foreignList.innerHTML = "";
Â  Â  Â  investList.innerHTML Â = "";

Â  Â  Â  const dailyBoth = new Set(
Â  Â  Â  Â  dailyForeign
Â  Â  Â  Â  Â  .map(i => i.stock_id)
Â  Â  Â  Â  Â  .filter(id => dailyInvest.some(j => j.stock_id === id))
Â  Â  Â  );

Â  Â  Â  const renderListItem = (listEl, items, ratioKey, bothSet) => {
Â  Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  const a = createStockLink(item.stock_id, item.name);

Â  Â  Â  Â  Â  const ratioValue = (item[ratioKey] * 100).toFixed(2);
Â  Â  Â  Â  Â  const text = document.createTextNode(` : ${ratioValue}%`);

Â  Â  Â  Â  Â  if (bothSet.has(item.stock_id)) {
Â  Â  Â  Â  Â  Â  li.classList.add("text-red-600", "font-bold");
Â  Â  Â  Â  Â  Â  a.className = "hover:underline text-red-600 font-bold";
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  li.appendChild(a);
Â  Â  Â  Â  Â  li.appendChild(text);
Â  Â  Â  Â  Â  listEl.appendChild(li);
Â  Â  Â  Â  });
Â  Â  Â  };

Â  Â  Â  renderListItem(foreignList, dailyForeign, 'foreign_ratio', dailyBoth);
Â  Â  Â  renderListItem(investList, dailyInvest, 'invest_ratio', dailyBoth);

Â  Â  Â  const periodRoot = document.getElementById("period-section");

Â  Â  Â  function buildPeriodBlock(titleHTML, foreignKey, investKey, prefix) {
Â  Â  Â  Â  const section = document.createElement("div");
Â  Â  Â  Â  section.className = "mt-6 border-t pt-4";
Â  Â  Â  Â  section.innerHTML = `
Â  Â  Â  Â  Â  <h4 class="font-bold text-xl mb-3">${titleHTML}</h4>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-6 text-gray-700">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h5 class="font-semibold mb-2 text-base">ğŸŒ å¤–è³‡</h5>
Â  Â  Â  Â  Â  Â  Â  <ul id="${prefix}-foreign" class="list-disc pl-6 space-y-2 text-base"></ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <h5 class="font-semibold mb-2 text-base">ğŸ¦ æŠ•ä¿¡</h5>
Â  Â  Â  Â  Â  Â  Â  <ul id="${prefix}-invest" class="list-disc pl-6 space-y-2 text-base"></ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  periodRoot.appendChild(section);

Â  Â  Â  Â  const fList = (data[foreignKey] || []).slice(0, 10);
Â  Â  Â  Â  const iList = (data[investKey] Â || []).slice(0, 10);

Â  Â  Â  Â  const both = new Set(
Â  Â  Â  Â  Â  fList.map(i => i.stock_id).filter(id => iList.some(j => j.stock_id === id))
Â  Â  Â  );

Â  Â  Â  Â  const fUl = document.getElementById(`${prefix}-foreign`);
Â  Â  Â  Â  const iUl = document.getElementById(`${prefix}-invest`);

Â  Â  Â  Â  renderListItem(fUl, fList, 'foreign_ratio', both);
Â  Â  Â  Â  renderListItem(iUl, iList, 'invest_ratio', both);
Â  Â  Â  }

Â  Â  Â  buildPeriodBlock(
Â  Â  Â  Â  "ğŸ“… è¿‘5æ—¥å¤–/æŠ•æœ¬æ¯”å‰ 10",
Â  Â  Â  Â  "foreign_ratio_5d_ranking",
Â  Â  Â  Â  "invest_ratio_5d_ranking",
Â  Â  Â  Â  "p5d"
Â  Â  Â  );

Â  Â  Â  buildPeriodBlock(
Â  Â  Â  Â  "ğŸ—“ï¸ è¿‘10æ—¥å¤–/æŠ•æœ¬æ¯”å‰ 10",
Â  Â  Â  Â  "foreign_ratio_10d_ranking",
Â  Â  Â  Â  "invest_ratio_10d_ranking",
Â  Â  Â  Â  "p10d"
Â  Â  Â  );
Â  Â  });

Â  fetch("newcomers.json")
Â  Â  .then(res => res.json())
Â  Â  .then(data => {
Â  Â  Â  const newcomers = data.newcomers || {};
Â  Â  Â  const container = document.getElementById("newcomers-container");
Â  Â  Â  container.innerHTML = "";

Â  Â  Â  const addList = (title, items) => {
Â  Â  Â  Â  if (items && items.length > 0) {
Â  Â  Â  Â  Â  const header = document.createElement("p");
Â  Â  Â  Â  Â  header.className = "font-semibold mt-2";
Â  Â  Â  Â  Â  header.textContent = title;
Â  Â  Â  Â  Â  container.appendChild(header);

Â  Â  Â  Â  Â  const ul = document.createElement("ul");
Â  Â  Â  Â  Â  ul.className = "list-disc pl-6 space-y-1";
Â  Â  Â  Â  Â  items.slice(0, 10).forEach(stock => {
Â  Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  Â  const a = createStockLink(stock.stock_id, stock.name);
Â  Â  Â  Â  Â  Â  li.appendChild(a);
Â  Â  Â  Â  Â  Â  ul.appendChild(li);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  container.appendChild(ul);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  addList("ğŸŒ å¤–è³‡æ–°ä¸Šæ¦œï¼š", newcomers.foreign);
Â  Â  Â  addList("ğŸ¦ æŠ•ä¿¡æ–°ä¸Šæ¦œï¼š", newcomers.invest);
Â  Â  Â  if ((!newcomers.foreign || newcomers.foreign.length === 0) &&
Â  Â  Â  Â  Â  (!newcomers.invest || newcomers.invest.length === 0)) {
Â  Â  Â  Â  container.textContent = "ï¼ˆä»Šæ—¥ç„¡æ–°ä¸Šæ¦œè‚¡ç¥¨ï¼‰";
Â  Â  Â  }
Â  Â  })
Â  Â  .catch(() => {
Â  Â  Â  document.getElementById("newcomers-container").textContent = "ç„¡æ³•è¼‰å…¥è³‡æ–™";
Â  Â  });

Â  fetch("explosive.json")
Â  Â  .then(res => res.json())
Â  Â  .then(data => {
Â  Â  Â  const container = document.getElementById("explosive-container");
Â  Â  Â  container.innerHTML = "";

Â  Â  Â  if (!data || !data.explosive || data.explosive.length === 0) {
Â  Â  Â  Â  container.textContent = "ï¼ˆä»Šæ—¥ç„¡çˆ†é‡è‚¡ç¥¨ï¼‰";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const ul = document.createElement("ul");
Â  Â  Â  ul.className = "list-disc pl-6 space-y-1";
Â  Â  Â  data.explosive.slice(0, 10).forEach(stock => {
Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  const a = createStockLink(stock.stock_id, stock.name);
Â  Â  Â  Â  li.appendChild(a);

Â  Â  Â  Â  const tag = document.createTextNode(` ${stock.tag}`);
Â  Â  Â  Â  li.appendChild(tag);
Â  Â  Â  Â  ul.appendChild(li);
Â  Â  Â  });
Â  Â  Â  container.appendChild(ul);
Â  Â  })
Â  Â  .catch(() => {
Â  Â  Â  document.getElementById("explosive-container").textContent = "ç„¡æ³•è¼‰å…¥è³‡æ–™";
Â  Â  });

Â  // --- æœå°‹ ---
Â  input.addEventListener("input", function() {
Â  Â  if (this.value.trim()) {
Â  Â  Â  clearBtn.classList.remove("hidden");
Â  Â  } else {
Â  Â  Â  clearBtn.classList.add("hidden");
Â  Â  Â  suggestions.classList.add("hidden");
Â  Â  Â  toggleView('insights');
Â  Â  }

Â  Â  const keyword = this.value.trim();
Â  Â  suggestions.innerHTML = "";
Â  Â  if (!keyword) { suggestions.classList.add("hidden"); return; }

Â  Â  const matched = stockList.filter(s =>
Â  Â  Â  s.id.includes(keyword) || s.name.includes(keyword)
Â  Â  ).slice(0, 10);

Â  Â  if (matched.length === 0) { suggestions.classList.add("hidden"); return; }

Â  Â  matched.forEach(s => {
Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  li.textContent = `${s.name} (${s.id})`;
Â  Â  Â  li.className = "p-2 hover:bg-gray-100 cursor-pointer";
Â  Â  Â  li.addEventListener("click", () => {
Â  Â  Â  Â  input.value = s.id;
Â  Â  Â  Â  suggestions.classList.add("hidden");
Â  Â  Â  Â  clearBtn.classList.remove("hidden");
Â  Â  Â  Â  showStockData(s.id);
Â  Â  Â  });
Â  Â  Â  suggestions.appendChild(li);
Â  Â  });
Â  Â  suggestions.classList.remove("hidden");
Â  });

Â  clearBtn.addEventListener("click", () => {
Â  Â  input.value = "";
Â  Â  clearBtn.classList.add("hidden");
Â  Â  suggestions.classList.add("hidden");

Â  Â  tableBody.innerHTML = `
Â  Â  Â  <tr>
Â  Â  Â  Â  <td colspan="5" class="border px-4 py-8 text-gray-500">
Â  Â  Â  Â  Â  è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±é€²è¡ŒæŸ¥è©¢
Â  Â  Â  Â  </td>
Â  Â  Â  </tr>
Â  Â  `;
Â  Â  toggleView('insights');
Â  Â  input.focus();
Â  });

Â  input.addEventListener("keyup", e => {
Â  Â  if (e.key === "Enter") {
Â  Â  Â  const keyword = e.target.value.trim();
Â  Â  Â  if (keyword) { showStockData(keyword); suggestions.classList.add("hidden"); }
Â  Â  }
Â  });

Â  function showStockData(keyword) {
Â  Â  tableBody.innerHTML = "";
Â  Â  const colorize = (val) => {
Â  Â  Â  const num = Number(val);
Â  Â  Â  const formattedVal = num.toLocaleString();
Â  Â  Â  if (num > 0) return `<span class="text-red-600">${formattedVal}</span>`;
Â  Â  Â  if (num < 0) return `<span class="text-green-600">${formattedVal}</span>`;
Â  Â  Â  return formattedVal;
Â  Â  };

Â  Â  const kw = keyword.toString().replace(/\s|ã€€/g, "").trim();
Â  Â  let foundStock = null;
Â  Â  let dataFound = false;

Â  Â  const chartLabels = [];
Â  Â  const chartForeignData = [];
Â  Â  const chartInvestData = [];
Â  Â  const chartDealerData = [];
Â  Â  const chartTotalData = [];

Â  Â  for (let i = records.length - 1; i >= 0; i--) {
Â  Â  Â  const day = records[i];
Â  Â  Â  const stock = day.stocks.find(s =>
Â  Â  Â  Â  s.stock_id.toString().replace(/\s|ã€€/g, "").trim() === kw ||
Â  Â  Â  Â  s.name.replace(/\s|ã€€/g, "").includes(kw)
Â  Â  Â  );
Â  Â  Â  if (stock) {
Â  Â  Â  Â  dataFound = true;
Â  Â  Â  Â  if (!foundStock) foundStock = stock;

Â  Â  Â  Â  const foreign = Math.round(stock.foreign_net/1000);
Â  Â  Â  Â  const invest Â = Math.round(stock.invest_net/1000);
Â  Â  Â  Â  const dealer Â = Math.round(stock.dealer_net/1000);
Â  Â  Â  Â  const total Â  = Math.round((stock.foreign_net + stock.invest_net + stock.dealer_net)/1000);

Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.className = "hover:bg-gray-50";
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td class="border px-4 py-2">${day.date}</td>
Â  Â  Â  Â  Â  <td class="border px-4 py-2">${colorize(foreign)}</td>
Â  Â  Â  Â  Â  <td class="border px-4 py-2">${colorize(invest)}</td>
Â  Â  Â  Â  Â  <td class="border px-4 py-2">${colorize(dealer)}</td>
Â  Â  Â  Â  Â  <td class="border px-4 py-2">${colorize(total)}</td>`;
Â  Â  Â  Â  tableBody.prepend(tr);

Â  Â  Â  Â  chartLabels.push(day.date);
Â  Â  Â  Â  chartForeignData.push(foreign);
Â  Â  Â  Â  chartInvestData.push(invest);
Â  Â  Â  Â  chartDealerData.push(dealer);
Â  Â  Â  Â  chartTotalData.push(total);
Â  Â  Â  }
Â  Â  }

Â  Â  if (foundStock && dataFound) {
Â  Â  Â  toggleView('stock');
Â  Â  Â  pageTitle.textContent = `æ³•äººè²·è³£è¶…æŸ¥è©¢ - ${foundStock.name} (${foundStock.stock_id})`;
Â  Â  Â  loadKlineData(foundStock.stock_id.toString());
Â  Â  Â  updateChart(chartLabels, chartForeignData, chartInvestData, chartDealerData, chartTotalData);
Â  Â  } else {
Â  Â  Â  toggleView('insights');
Â  Â  Â  pageTitle.textContent = "æ³•äººè²·è³£è¶…æŸ¥è©¢";
Â  Â  Â  console.log(`[ğŸ” LOG - Search] æŸ¥è©¢å¤±æ•—æˆ–ç„¡æ³•äººè²·è³£è¶…è³‡æ–™: ${keyword}`);
Â  Â  }
Â  }

Â  function updateChart(labels, foreignData, investData, dealerData, totalData) {
Â  Â  const ctx = document.getElementById('tradingChart').getContext('2d');

Â  Â  if (tradingChart) tradingChart.destroy();

Â  Â  tradingChart = new Chart(ctx, {
Â  Â  Â  type: 'line',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  datasets: [
Â  Â  Â  Â  Â  { label: 'å¤–è³‡', data: foreignData, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', tension: 0.3, fill: false },
Â  Â  Â  Â  Â  { label: 'æŠ•ä¿¡', data: investData, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', tension: 0.3, fill: false },
Â  Â  Â  Â  Â  { label: 'è‡ªç‡Ÿå•†', data: dealerData, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.5)', tension: 0.3, fill: false },
Â  Â  Â  Â  Â  { label: 'åˆè¨ˆ', data: totalData, borderColor: 'rgb(153, 102, 255)', backgroundColor: 'rgba(153, 102, 255, 0.5)', tension: 0.3, fill: false, borderWidth: 2 }
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true, maintainAspectRatio: false,
Â  Â  Â  Â  plugins: { title: { display: false }, tooltip: { mode: 'index', intersect: false } },
Â  Â  Â  Â  scales: { x: { title: { display: true, text: 'æ—¥æœŸ' } }, y: { title: { display: true, text: 'è²·è³£è¶…å¼µæ•¸' } } }
Â  Â  Â  }
Â  Â  });
Â  }

Â  const ensureFiniteNumber = (value) => {
Â  Â  Â  const num = Number(value);
Â  Â  Â  return (Number.isFinite(num) && num !== null) ? num : 0;
Â  };

Â  /**
Â   * è¨ˆç®—ç°¡å–®ç§»å‹•å¹³å‡ç·š (Simple Moving Average, SMA)
Â   */
Â  function calculateSMA(data, period) {
Â  Â  Â  const result = [];
Â  Â  Â  for (let i = 0; i < data.length; i++) {
Â  Â  Â  Â  Â  const currentClose = ensureFiniteNumber(data[i].close);
Â  Â  Â  Â  Â  if (i < period - 1) { result.push({ time: data[i].time, value: null }); continue; }
Â  Â  Â  Â  Â  let sum = 0;
Â  Â  Â  Â  Â  for (let j = 0; j < period; j++) sum += ensureFiniteNumber(data[i - j].close);
Â  Â  Â  Â  Â  result.push({ time: data[i].time, value: sum / period });
Â  Â  Â  }
Â  Â  Â  return result;
Â  }

Â  /**
Â   * ç¹ªè£½éœæ…‹åœ–ä¾‹ (åœ–è¡¨ä¸‹æ–¹)
Â   */
Â  function drawStaticLegend(periods) {
Â  Â  Â  klineStaticLegend.innerHTML = '';
Â  Â  Â  periods.forEach(ma => {
Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  item.className = 'legend-item mx-2';
Â  Â  Â  Â  Â  const colorBox = document.createElement('span');
Â  Â  Â  Â  Â  colorBox.className = 'legend-color w-3 h-1.5';
Â  Â  Â  Â  Â  colorBox.style.backgroundColor = ma.color;
Â  Â  Â  Â  Â  const titleText = document.createTextNode(` ${ma.title}`);
Â  Â  Â  Â  Â  item.appendChild(colorBox);
Â  Â  Â  Â  Â  item.appendChild(titleText);
Â  Â  Â  Â  Â  klineStaticLegend.appendChild(item);
Â  Â  Â  });
Â  }

Â  /**
Â   * ç›£è½æ»‘é¼ ç§»å‹•äº‹ä»¶ï¼Œæ›´æ–°è‡ªè¨‚åœ–ä¾‹ (Tooltip)
Â   */
Â  function updateCustomTooltip(param) {
Â  Â  Â  if (!klineLegend) return;
Â  Â  Â  
Â  Â  Â  // å¦‚æœæ²’æœ‰æ™‚é–“é»æ•¸æ“šï¼Œå‰‡éš±è—åœ–ä¾‹
Â  Â  Â  if (!param.time) { klineLegend.classList.add('hidden'); return; }

Â  Â  Â  // å°‡æ™‚é–“æˆ³è¨˜ (ç§’) è½‰æ›ç‚º Date ç‰©ä»¶
Â  Â  Â  const date = new Date(param.time * 1000);
Â  Â  Â  // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
Â  Â  Â  const formattedDate = date.toLocaleDateString('zh-TW', {
Â  Â  Â  Â  Â  year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Taipei'
Â  Â  Â  }).replace(/\//g, '-');

Â  Â  Â  let html = `<div class="font-bold mb-1">${formattedDate}</div>`;
Â  Â  Â  const maData = {};
Â  Â  Â  let volumeValue = null, openValue = null, highValue = null, lowValue = null, closeValue = null;

Â  Â  Â  param.seriesData.forEach((data, series) => {
Â  Â  Â  Â  Â  if (series === candleSeries) {
Â  Â  Â  Â  Â  Â  Â  if (data.value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  openValue = data.value.open.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  highValue = data.value.high.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  lowValue Â = data.value.low.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  closeValue= data.value.close.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else if (series === volumeSeries) {
Â  Â  Â  Â  Â  Â  Â  volumeValue = data.value;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  const ma = MA_PERIODS.find(m => m.series === series);
Â  Â  Â  Â  Â  Â  Â  if (ma && data.value) maData[ma.title] = { value: data.value, color: ma.color };
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  if (openValue !== null) {
Â  Â  Â  Â  Â  // åˆ¤æ–·ç´…ç¶ Kç·š
Â  Â  Â  Â  Â  const closeColor = closeValue > openValue ? 'text-red-600' : (closeValue < openValue ? 'text-green-600' : 'text-gray-700');
Â  Â  Â  Â  Â  html += `<div class="${closeColor}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-gray-600">O:</span> ${openValue}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-gray-600">H:</span> ${highValue}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-gray-600">L:</span> ${lowValue}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-gray-600">C:</span> <span class="font-bold">${closeValue}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  }

Â  Â  Â  MA_PERIODS.forEach(ma => {
Â  Â  Â  Â  Â  const data = maData[ma.title];
Â  Â  Â  Â  Â  const value = data ? data.value.toFixed(2) : '-';
Â  Â  Â  Â  Â  html += `<div class="legend-item"><span class="legend-color" style="background-color: ${ma.color}"></span> ${ma.title}: ${value}</div>`;
Â  Â  Â  });

Â  Â  Â  const vol = volumeValue !== null ? (volumeValue / 1000000).toFixed(2) + 'M' : '-';
Â  Â  Â  html += `<div class="mt-1"><span class="font-semibold text-gray-600">æˆäº¤é‡:</span> ${vol}</div>`;

Â  Â  Â  klineLegend.innerHTML = html;
Â  Â  Â  klineLegend.classList.remove('hidden');

Â  Â  Â  // èª¿æ•´ tooltip ä½ç½®
Â  Â  Â  const chartWidth = klineChartContainer.clientWidth;
Â  Â  Â  const tooltipWidth = klineLegend.offsetWidth;
Â  Â  Â  const pointX = param.point ? param.point.x : chartWidth / 2;
Â  Â  Â  let left = pointX + 15;
Â  Â  Â  if (left + tooltipWidth > chartWidth) {
Â  Â  Â  Â  Â  left = pointX - tooltipWidth - 15;
Â  Â  Â  Â  Â  if (left < 10) left = 10;
Â  Â  Â  }
Â  Â  Â  klineLegend.style.left = `${left}px`;
Â  }

Â  // --- K ç·šåœ–åŠŸèƒ½ ---
Â  function loadKlineData(stockId) {
Â  Â  Â  if (!klineChartContainer) return;

Â  Â  Â  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</div>
Â  Â  Â  Â  Â  <div id="kline-legend" class="hidden"></div>`;
Â  Â  Â  klineLegend = document.getElementById('kline-legend');

Â  Â  Â  if(klineStaticLegend) klineStaticLegend.innerHTML = '';
Â  Â  Â  if (klineChart) { try { klineChart.remove(); } catch (e) {} klineChart = null; }
Â  Â  Â  candleSeries = null; volumeSeries = null; MA_PERIODS.forEach(ma => ma.series = null);

Â  Â  Â  fetch("Kline.json")
Â  Â  Â  Â  Â  .then(res => { if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`); return res.json(); })
Â  Â  Â  Â  Â  .then(klineData => {
Â  Â  Â  Â  Â  Â  Â  let filteredData = [];
Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(klineData) && klineData[stockId]) filteredData = klineData[stockId];
Â  Â  Â  Â  Â  Â  Â  else if (Array.isArray(klineData)) filteredData = klineData.filter(item => String(item.stock_id).trim() === String(stockId));
Â  Â  Â  Â  Â  Â  Â  else if (Array.isArray(klineData.stocks)) filteredData = klineData.stocks.filter(item => String(item.stock_id).trim() === String(stockId));

Â  Â  Â  Â  Â  Â  Â  if (!filteredData || filteredData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾ä¸åˆ° ${stockId} çš„ K ç·šè³‡æ–™ã€‚</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  const chartData = [];
Â  Â  Â  Â  Â  Â  Â  filteredData.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const o = ensureFiniteNumber(item.open), h = ensureFiniteNumber(item.high),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  l = ensureFiniteNumber(item.low), Â c = ensureFiniteNumber(item.close),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  v = ensureFiniteNumber(item.volume);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!o || !h || !l || !c) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = (item.date || item.Date || item.trade_date || "").toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!dateStr) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  // â­ ä¿®æ­£æ—¥æœŸåç§»å•é¡Œï¼šå°‡æ—¥æœŸå­—ä¸²è½‰æ›ç‚ºç•¶æ—¥åˆå¤œçš„ Unix æ™‚é–“æˆ³è¨˜ (ç§’)
Â  Â  Â  Â  Â  Â  Â  Â  Â  const t = new Date(dateStr.replace(/-/g,'/')).getTime()/1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  chartData.push({ time:t, open:o, high:h, low:l, close:c, value:v });
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  if (chartData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  klineChartContainer.innerHTML = `<div class="text-center py-4 text-gray-500">æ‰¾åˆ°åŸå§‹è³‡æ–™ï¼Œä½†ç„¡æ³•ç¹ªè£½æœ‰æ•ˆ K ç·šã€‚</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
              
              // æ ¹æ“šè¢å¹•å¯¬åº¦è¨­å®šåœ–è¡¨é«˜åº¦
Â  Â  Â  Â  Â  Â  Â  const isDesktop = window.innerWidth > 768;
Â  Â  Â  Â  Â  Â  Â  const chartHeight = isDesktop ? 450 : 300;
Â  Â  Â  Â  Â  Â  Â  klineChartContainer.style.height = chartHeight + "px";

Â  Â  Â  Â  Â  Â  Â  klineChartContainer.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  const width = klineChartContainer.clientWidth || 600;

Â  Â  Â  Â  Â  Â  Â  // é‡æ–°åˆå§‹åŒ–åœ–è¡¨
Â  Â  Â  Â  Â  Â  Â  klineChart = LightweightCharts.createChart(klineChartContainer, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  width, height: chartHeight,
Â  Â  Â  Â  Â  Â  Â  Â  Â  layout: { backgroundColor: '#ffffff', textColor: '#333' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vertLines: { color: '#e0e0e0' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horzLines: { color: '#e0e0e0' }
Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  timeScale: { timeVisible: true, secondsVisible: false },
Â  Â  Â  Â  Â  Â  Â  Â  Â  crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  candleSeries = klineChart.addCandlestickSeries({
Â  Â  Â  Â  Â  Â  Â  Â  Â  upColor: '#ef5350', downColor: '#26a69a',
Â  Â  Â  Â  Â  Â  Â  Â  Â  borderVisible: false, wickUpColor: '#ef5350', wickDownColor: '#26a69a',
Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'Kç·š', lastValueVisible: true, priceLineVisible: true,
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  candleSeries.setData(chartData);

Â  Â  Â  Â  Â  Â  Â  // ----- ç¹ªè£½ MA å‡ç·šç³»åˆ— -----
Â  Â  Â  Â  Â  Â  Â  MA_PERIODS.forEach(ma => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const maData = calculateSMA(chartData, ma.period);
Â  Â  Â  Â  Â  Â  Â  Â  Â  const maSeries = klineChart.addLineSeries({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: ma.color, lineWidth: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: '', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastValueVisible: false, priceLineVisible: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  maSeries.setData(maData.filter(d => d.value !== null).map(d => ({ time: d.time, value: d.value })));
Â  Â  Â  Â  Â  Â  Â  Â  Â  ma.series = maSeries;
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  drawStaticLegend(MA_PERIODS);

Â  Â  Â  Â  Â  Â  Â  // â–¶ èª¿æ•´è‚¡åƒ¹çš„ price scale
Â  Â  Â  Â  Â  Â  Â  klineChart.priceScale('right').applyOptions({
Â  Â  Â  Â  Â  Â  Â  Â  Â  scaleMargins: { top: 0.05, bottom: 0.25 }
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  // æˆäº¤é‡ series
Â  Â  Â  Â  Â  Â  Â  volumeSeries = klineChart.addHistogramSeries({
Â  Â  Â  Â  Â  Â  Â  Â  Â  priceScaleId: 'volume',
Â  Â  Â  Â  Â  Â  Â  Â  Â  priceFormat: { type: 'volume' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'æˆäº¤é‡', lastValueVisible: true, priceLineVisible: true,
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  klineChart.priceScale('volume').applyOptions({
Â  Â  Â  Â  Â  Â  Â  Â  Â  scaleMargins: { top: 0.8, bottom: 0 }
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  volumeSeries.setData(chartData.map(d => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  time: d.time, value: ensureFiniteNumber(d.value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  color: d.close >= d.open ? '#ef535099' : '#26a69a99',
Â  Â  Â  Â  Â  Â  Â  })));

Â  Â  Â  Â  Â  Â  Â  klineChart.subscribeCrosshairMove(updateCustomTooltip);
Â  Â  Â  Â  Â  Â  Â  klineChart.timeScale().fitContent();
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  console.error("[âŒ LOG - Kline] K ç·šåœ–è¼‰å…¥éŒ¯èª¤:", err);
Â  Â  Â  Â  Â  Â  Â  klineChartContainer.innerHTML = `<div class="text-center py-4 text-red-500">K ç·šåœ–è¼‰å…¥éŒ¯èª¤ã€‚</div>`;
Â  Â  Â  Â  Â  });
Â  }

Â  window.addEventListener('resize', () => {
Â  Â  Â  if (klineChart && klineChartContainer) {
Â  Â  Â  Â  Â  const isDesktop = window.innerWidth > 768;
Â  Â  Â  Â  Â  const chartHeight = isDesktop ? 450 : 300;
Â  Â  Â  Â  Â  klineChartContainer.style.height = chartHeight + "px";
Â  Â  Â  Â  Â  // æ›´æ–°åœ–è¡¨å°ºå¯¸
Â  Â  Â  Â  Â  klineChart.applyOptions({ width: klineChartContainer.clientWidth || 600, height: chartHeight });
Â  Â  Â  }
Â  });
Â  </script>
</body>
</html>
