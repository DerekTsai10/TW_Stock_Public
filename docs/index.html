<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">
  <title>法人買賣超查詢</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6 bg-gray-50 text-base">
  <h1 id="page-title" class="text-3xl font-bold mb-6">法人買賣超查詢</h1>

  <!-- 搜尋框 -->
  <div class="mb-6">
    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">輸入股票代碼或名稱：</label>
    <input id="search-input" type="text" placeholder="台積電 或 2330"
      class="w-full p-2 border rounded-md shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-400">
  </div>

  <!-- 上半部：指標觀察清單 + 新上榜 + 成交量暴增 -->
  <div class="grid grid-cols-2 gap-6">
    <!-- 左邊：指標觀察清單 -->
    <div class="bg-white shadow rounded-2xl p-4">
      <h2 class="text-xl font-bold mb-2">📊 指標觀察清單 (資料日期：<span id="insights-date"></span>)</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold mb-1">🌐 外資買超投本比前 10</h3>
          <ul id="foreign-top10" class="list-disc list-inside space-y-1"></ul>
        </div>
        <div>
          <h3 class="font-bold mb-1">🏦 投信買超投本比前 10</h3>
          <ul id="invest-top10" class="list-disc list-inside space-y-1"></ul>
        </div>
      </div>
    </div>

    <!-- 右邊：新上榜 + 成交量暴增 -->
    <div class="bg-white shadow rounded-2xl p-4">
      <h2 class="text-xl font-bold mb-2">🚀 新上榜</h2>
      <p id="newcomers-date" class="text-sm text-gray-500 mb-3">資料日期：</p>

      <div id="foreign-newcomers" class="mb-4"></div>
      <div id="invest-newcomers" class="mb-4"></div>

      <!-- 成交量暴增 -->
      <h2 class="text-xl font-bold mt-6 mb-2">🔥 成交量暴增 (前 10 檔)</h2>
      <div id="volume-spike"></div>
    </div>
  </div>

  <!-- 下半部：EPS 區塊 -->
  <div class="bg-white shadow rounded-2xl p-4 mt-6">
    <h2 class="text-xl font-bold mb-2">💰 EPS 趨勢</h2>
    <canvas id="eps-chart" class="w-full h-64"></canvas>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function loadInsights() {
      const res = await fetch("insights.json");
      const data = await res.json();

      document.getElementById("insights-date").innerText = data.date;

      // 外資 Top10
      let fhtml = "";
      data.foreign_ratio_ranking.forEach(s => {
        fhtml += `<li>${s.name} (${s.stock_id}) - ${s.foreign_ratio.toFixed(2)}%</li>`;
      });
      document.getElementById("foreign-top10").innerHTML = fhtml;

      // 投信 Top10
      let ihtml = "";
      data.invest_ratio_ranking.forEach(s => {
        ihtml += `<li>${s.name} (${s.stock_id}) - ${s.invest_ratio.toFixed(2)}%</li>`;
      });
      document.getElementById("invest-top10").innerHTML = ihtml;
    }

    async function loadNewcomers() {
      const res = await fetch("newcomers.json");
      const data = await res.json();

      document.getElementById("newcomers-date").innerText = "資料日期：" + data.date;

      renderNewcomerList("foreign-newcomers", "外資新上榜", data.newcomers.foreign);
      renderNewcomerList("invest-newcomers", "投信新上榜", data.newcomers.invest);
      renderVolumeSpike("volume-spike", data.volume_spike);
    }

    function renderNewcomerList(containerId, title, list) {
      let html = `<h3 class="font-bold mb-1">📌 ${title}：</h3>`;

      if (!list || list.length === 0) {
        html += `<p class="text-gray-400">（無）</p>`;
        document.getElementById(containerId).innerHTML = html;
        return;
      }

      if (list.length <= 3) {
        html += `<ul class="list-disc list-inside space-y-1">`;
        list.forEach(s => {
          html += `<li>${s.name} (${s.stock_id}) - ${s.ratio.toFixed(2)}%</li>`;
        });
        html += `</ul>`;
      } else {
        const left = list.slice(0, 3);
        const right = list.slice(3, 6);

        html += `<div class="grid grid-cols-2 gap-4">`;

        html += `<div><ul class="list-disc list-inside space-y-1">`;
        left.forEach(s => {
          html += `<li>${s.name} (${s.stock_id}) - ${s.ratio.toFixed(2)}%</li>`;
        });
        html += `</ul></div>`;

        html += `<div><ul class="list-disc list-inside space-y-1">`;
        right.forEach(s => {
          html += `<li>${s.name} (${s.stock_id}) - ${s.ratio.toFixed(2)}%</li>`;
        });
        html += `</ul></div>`;

        html += `</div>`;
      }

      document.getElementById(containerId).innerHTML = html;
    }

    function renderVolumeSpike(containerId, list) {
      let html = "";

      if (!list || list.length === 0) {
        html = `<p class="text-gray-400">（今日無成交量暴增股票）</p>`;
      } else {
        // 取前 10 檔倍率最高的股票
        list = list.sort((a, b) => b.ratio - a.ratio).slice(0, 10);

        html = `<ul class="list-disc list-inside space-y-1">`;
        list.forEach(s => {
          html += `<li>${s.name} (${s.stock_id}) - ${s.ratio}x</li>`;
        });
        html += `</ul>`;
      }

      document.getElementById(containerId).innerHTML = html;
    }

    // EPS Chart
    async function loadEPS(stockId="2330") {
      const res = await fetch("eps.json");
      const data = await res.json();
      const epsData = data[stockId] || [];

      const ctx = document.getElementById("eps-chart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: epsData.map(d => d.date),
          datasets: [{
            label: "EPS",
            data: epsData.map(d => d.eps),
            borderColor: "blue",
            fill: false
          }]
        }
      });
    }

    loadInsights();
    loadNewcomers();
    loadEPS();
  </script>
</body>
</html>
