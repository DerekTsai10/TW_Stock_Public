<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台股交易追蹤</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { font-size: 26px; margin-bottom: 15px; }
    h2 { font-size: 20px; margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    .container { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .left, .right { width: 48%; }
    #stockSearch { padding: 5px; width: 180px; }
    #watchlist, #newcomersList { margin: 0; padding-left: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 左上 -->
    <div class="left">
      <h2>指標觀察清單</h2>
      <ul id="watchlist">
        <li>台積電 (2330)</li>
        <li>聯發科 (2454)</li>
        <li>台燿 (6274)</li>
      </ul>

      <!-- 新增搜尋 -->
      <div style="margin-top: 10px;">
        <label for="stockSearch">輸入股票代碼或名稱：</label><br>
        <input type="text" id="stockSearch" placeholder="例如：2330 或 台積電">
        <button onclick="searchStock()">搜尋</button>
      </div>
    </div>

    <!-- 右上 -->
    <div class="right">
      <h2>【新上榜】法人買超前15</h2>
      <ul id="newcomersList"></ul>
    </div>
  </div>

  <!-- 主標題 -->
  <h1>台股交易追蹤</h1>

  <!-- 下方內容 -->
  <div class="container">
    <!-- 左下 -->
    <div class="left">
      <h2>法人買賣超紀錄</h2>
      <div id="dataTable"></div>
    </div>

    <!-- 右下 -->
    <div class="right">
      <h2>近五年 EPS</h2>
      <canvas id="epsChart"></canvas>
    </div>
  </div>

  <script>
    let epsChart;

    // 初始化
    async function init() {
      await loadNewcomers();
      await updateTable("2330");  // 預設顯示台積電
      await updateEPS("2330");
    }

    // 搜尋功能
    async function searchStock() {
      const input = document.getElementById("stockSearch").value.trim();
      if (!input) return;

      await updateTable(input);
      await updateEPS(input);
    }

    // 載入新上榜清單
    async function loadNewcomers() {
      try {
        const resp = await fetch("newcomers.json");
        const data = await resp.json();
        const list = document.getElementById("newcomersList");
        list.innerHTML = "";
        data.forEach(stock => {
          const li = document.createElement("li");
          li.textContent = stock;
          list.appendChild(li);
        });
      } catch (e) {
        console.error("載入 newcomers.json 失敗", e);
      }
    }

    // 更新法人買賣超表格
    async function updateTable(stockCode) {
      try {
        const resp = await fetch("data.json");
        const data = await resp.json();
        const tableDiv = document.getElementById("dataTable");

        if (!data[stockCode]) {
          tableDiv.innerHTML = `<p>查無資料：${stockCode}</p>`;
          return;
        }

        const records = data[stockCode];
        let html = "<table><tr><th>日期</th><th>外資</th><th>投信</th><th>自營商</th></tr>";
        records.forEach(r => {
          html += `<tr>
            <td>${r.date}</td>
            <td style="color:${r.foreign > 0 ? 'red' : 'green'}">${r.foreign}</td>
            <td style="color:${r.investment > 0 ? 'red' : 'green'}">${r.investment}</td>
            <td style="color:${r.dealer > 0 ? 'red' : 'green'}">${r.dealer}</td>
          </tr>`;
        });
        html += "</table>";
        tableDiv.innerHTML = html;
      } catch (e) {
        console.error("載入 data.json 失敗", e);
      }
    }

    // 更新 EPS 折線圖
    async function updateEPS(stockCode) {
      try {
        const resp = await fetch("eps.json");
        const data = await resp.json();
        const ctx = document.getElementById("epsChart").getContext("2d");

        if (!data[stockCode]) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          return;
        }

        const epsData = data[stockCode];
        const labels = epsData.map(r => r.year + "Q" + r.quarter);
        const values = epsData.map(r => r.value);

        if (epsChart) epsChart.destroy();

        epsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "EPS",
              data: values,
              borderWidth: 2,
              fill: false,
              tension: 0.1
            }]
          }
        });
      } catch (e) {
        console.error("載入 eps.json 失敗", e);
      }
    }

    init();
  </script>
</body>
</html>
